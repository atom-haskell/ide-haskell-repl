"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const ide_haskell_repl_base_1 = require("./ide-haskell-repl-base");
const ide_haskell_repl_bg_1 = require("./ide-haskell-repl-bg");
class UPIConsumer {
    constructor(register) {
        this.messages = [];
        this.errors = new Map();
        this.disposables = new atom_1.CompositeDisposable();
        this.maxMessageTime = 10000;
        this.bgEditorMap = new Map();
        this.disposables.add((this.upiRepl = register({
            name: 'ide-haskell-repl',
            messageTypes: {
                repl: {
                    uriFilter: false,
                    autoScroll: true,
                },
            },
            tooltip: this.shouldShowTooltip.bind(this),
            events: {
                onDidSaveBuffer: this.didSaveBuffer.bind(this),
            },
        })), (this.upiErrors = register({
            name: 'ide-haskell-repl::errors',
        })));
    }
    dispose() {
        for (const proc of this.bgEditorMap.values()) {
            proc.destroy();
        }
        this.bgEditorMap.clear();
        this.disposables.dispose();
    }
    async getBuilder() {
        return this.upiRepl.getOthersConfigParam('ide-haskell-cabal', 'builder');
    }
    setErrors(source, errors) {
        this.errors.set(source, this.convert(errors));
        this.sendAllErrors();
    }
    setMessages(messages) {
        const all = this.convert(messages);
        this.messages = this.messages.filter(({ _time }) => Date.now() - _time < this.maxMessageTime);
        this.messages.push(...all.filter(({ severity }) => severity === 'repl'));
        this.upiRepl.setMessages(this.messages);
    }
    convert(xs) {
        const _time = Date.now();
        return xs.map((x) => (Object.assign({}, x, { _time })));
    }
    sendAllErrors() {
        let errors = [];
        for (const [source, errorArr] of this.errors.entries()) {
            if (!atom.config.get('ide-haskell-repl.checkOnSave') &&
                source.startsWith('bg:')) {
                continue;
            }
            errors = errors.filter((x) => !errorArr.some((y) => x._time <= y._time &&
                x.context === y.context &&
                compareMessage(x.message, y.message) &&
                comparePosition(x.position, y.position) &&
                x.severity === y.severity));
            errors.push(...errorArr);
        }
        this.upiErrors.setMessages(errors);
    }
    async shouldShowTooltip(editor, crange, _type) {
        if (!atom.config.get('ide-haskell-repl.showTypes')) {
            return undefined;
        }
        const path = editor.getPath();
        if (!path)
            return undefined;
        const buffer = editor.getBuffer();
        const { cwd, cabal, comp } = await ide_haskell_repl_base_1.IdeHaskellReplBase.componentFromURI(path);
        const hash = `${cwd.getPath()}::${cabal && cabal.name}::${comp && comp[0]}`;
        let bg = this.bgEditorMap.get(hash);
        if (!bg)
            bg = this.createNewBgRepl(hash, path, buffer);
        return bg.showTypeAt(path, crange);
    }
    async didSaveBuffer(buffer) {
        if (!atom.config.get('ide-haskell-repl.checkOnSave') &&
            !atom.config.get('ide-haskell-repl.showTypes')) {
            return;
        }
        const path = buffer.getPath();
        if (!path)
            return;
        const { cwd, cabal, comp } = await ide_haskell_repl_base_1.IdeHaskellReplBase.componentFromURI(path);
        const hash = `${cwd.getPath()}::${cabal && cabal.name}::${comp && comp[0]}`;
        const bgt = this.bgEditorMap.get(hash);
        if (bgt) {
            bgt.ghciReload();
        }
        else {
            this.createNewBgRepl(hash, path, buffer);
        }
    }
    createNewBgRepl(hash, path, buffer) {
        const bg = new ide_haskell_repl_bg_1.IdeHaskellReplBg(this, { uri: path });
        this.bgEditorMap.set(hash, bg);
        const disp = new atom_1.CompositeDisposable();
        disp.add(new atom_1.Disposable(() => {
            this.disposables.delete(disp);
            this.bgEditorMap.delete(hash);
            bg.destroy();
        }), buffer.onDidDestroy(() => disp.dispose()));
        this.disposables.add(disp);
        return bg;
    }
}
exports.UPIConsumer = UPIConsumer;
function comparePosition(x, y) {
    if (x && y) {
        return atom_1.Point.fromObject(x).isEqual(y);
    }
    else {
        return x === y;
    }
}
function compareMessage(x, y) {
    if (typeof x === 'string' && typeof y === 'string') {
        return x === y;
    }
    else if (isTextMessage(x) && isTextMessage(y)) {
        return x.text === y.text;
    }
    else if (isHTMLMessage(x) && isHTMLMessage(y)) {
        return x.html === y.html;
    }
    return false;
}
function isTextMessage(x) {
    return x.text !== undefined;
}
function isHTMLMessage(x) {
    return x.text !== undefined;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBpQ29uc3VtZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXBpQ29uc3VtZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFPQSwrQkFRYTtBQUNiLG1FQUE0RDtBQUM1RCwrREFBd0Q7QUFNeEQ7SUFTRSxZQUFZLFFBQTBCO1FBTjlCLGFBQVEsR0FBaUIsRUFBRSxDQUFBO1FBQzNCLFdBQU0sR0FBOEIsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUM3QyxnQkFBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUN2QyxtQkFBYyxHQUFHLEtBQUssQ0FBQTtRQUN0QixnQkFBVyxHQUFHLElBQUksR0FBRyxFQUE0QixDQUFBO1FBR3ZELElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUNsQixDQUFDLElBQUksQ0FBQyxPQUFPLEdBQUcsUUFBUSxDQUFDO1lBQ3ZCLElBQUksRUFBRSxrQkFBa0I7WUFDeEIsWUFBWSxFQUFFO2dCQUNaLElBQUksRUFBRTtvQkFDSixTQUFTLEVBQUUsS0FBSztvQkFDaEIsVUFBVSxFQUFFLElBQUk7aUJBQ2pCO2FBQ0Y7WUFDRCxPQUFPLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDMUMsTUFBTSxFQUFFO2dCQUNOLGVBQWUsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7YUFDL0M7U0FDRixDQUFDLENBQUMsRUFDSCxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDO1lBQ3pCLElBQUksRUFBRSwwQkFBMEI7U0FDakMsQ0FBQyxDQUFDLENBQ0osQ0FBQTtJQUNILENBQUM7SUFFTSxPQUFPO1FBQ1osR0FBRyxDQUFDLENBQUMsTUFBTSxJQUFJLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFFN0MsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFBO1FBQ2hCLENB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QUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDaEQsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQTtJQUMxQixDQUFDO0lBQ0QsTUFBTSxDQUFDLEtBQUssQ0FBQTtBQUNkLENBQUM7QUFFRCx1QkFBdUIsQ0FBd0I7SUFDN0MsTUFBTSxDQUFFLENBQVMsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFBO0FBQ3RDLENBQUM7QUFFRCx1QkFBdUIsQ0FBd0I7SUFDN0MsTUFBTSxDQUFFLENBQVMsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFBO0FBQ3RDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJVVBJSW5zdGFuY2UsXG4gIElSZXN1bHRJdGVtLFxuICBJVVBJUmVnaXN0cmF0aW9uLFxuICBJTWVzc2FnZVRleHQsXG4gIElNZXNzYWdlSFRNTCxcbn0gZnJvbSAnYXRvbS1oYXNrZWxsLXVwaSdcbmltcG9ydCB7XG4gIENvbXBvc2l0ZURpc3Bvc2FibGUsXG4gIFRleHRFZGl0b3IsXG4gIFJhbmdlLFxuICBUZXh0QnVmZmVyLFxuICBEaXNwb3NhYmxlLFxuICBQb2ludCxcbiAgUG9pbnRDb21wYXRpYmxlLFxufSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgSWRlSGFza2VsbFJlcGxCYXNlIH0gZnJvbSAnLi9pZGUtaGFza2VsbC1yZXBsLWJhc2UnXG5pbXBvcnQgeyBJZGVIYXNrZWxsUmVwbEJnIH0gZnJvbSAnLi9pZGUtaGFza2VsbC1yZXBsLWJnJ1xuXG5leHBvcnQgaW50ZXJmYWNlIElFcnJvckl0ZW0gZXh0ZW5kcyBJUmVzdWx0SXRlbSB7XG4gIF90aW1lOiBudW1iZXJcbn1cblxuZXhwb3J0IGNsYXNzIFVQSUNvbnN1bWVyIHtcbiAgcHJpdmF0ZSB1cGlSZXBsOiBJVVBJSW5zdGFuY2VcbiAgcHJpdmF0ZSB1cGlFcnJvcnM6IElVUElJbnN0YW5jZVxuICBwcml2YXRlIG1lc3NhZ2VzOiBJRXJyb3JJdGVtW10gPSBbXVxuICBwcml2YXRlIGVycm9yczogTWFwPHN0cmluZywgSUVycm9ySXRlbVtdPiA9IG5ldyBNYXAoKVxuICBwcml2YXRlIGRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICBwcml2YXRlIG1heE1lc3NhZ2VUaW1lID0gMTAwMDBcbiAgcHJpdmF0ZSBiZ0VkaXRvck1hcCA9IG5ldyBNYXA8c3RyaW5nLCBJZGVIYXNrZWxsUmVwbEJnPigpXG5cbiAgY29uc3RydWN0b3IocmVnaXN0ZXI6IElVUElSZWdpc3RyYXRpb24pIHtcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgICh0aGlzLnVwaVJlcGwgPSByZWdpc3Rlcih7XG4gICAgICAgIG5hbWU6ICdpZGUtaGFza2VsbC1yZXBsJyxcbiAgICAgICAgbWVzc2FnZVR5cGVzOiB7XG4gICAgICAgICAgcmVwbDoge1xuICAgICAgICAgICAgdXJpRmlsdGVyOiBmYWxzZSxcbiAgICAgICAgICAgIGF1dG9TY3JvbGw6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgdG9vbHRpcDogdGhpcy5zaG91bGRTaG93VG9vbHRpcC5iaW5kKHRoaXMpLFxuICAgICAgICBldmVudHM6IHtcbiAgICAgICAgICBvbkRpZFNhdmVCdWZmZXI6IHRoaXMuZGlkU2F2ZUJ1ZmZlci5iaW5kKHRoaXMpLFxuICAgICAgICB9LFxuICAgICAgfSkpLFxuICAgICAgKHRoaXMudXBpRXJyb3JzID0gcmVnaXN0ZXIoe1xuICAgICAgICBuYW1lOiAnaWRlLWhhc2tlbGwtcmVwbDo6ZXJyb3JzJyxcbiAgICAgIH0pKSxcbiAgICApXG4gIH1cblxuICBwdWJsaWMgZGlzcG9zZSgpIHtcbiAgICBmb3IgKGNvbnN0IHByb2Mgb2YgdGhpcy5iZ0VkaXRvck1hcC52YWx1ZXMoKSkge1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgICBwcm9jLmRlc3Ryb3koKVxuICAgIH1cbiAgICB0aGlzLmJnRWRpdG9yTWFwLmNsZWFyKClcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldEJ1aWxkZXIoKSB7XG4gICAgcmV0dXJuIHRoaXMudXBpUmVwbC5nZXRPdGhlcnNDb25maWdQYXJhbTx7XG4gICAgICBuYW1lOiAnY2FiYWwnIHwgJ3N0YWNrJyB8ICdjYWJhbC1uaXgnIHwgJ25vbmUnXG4gICAgfT4oJ2lkZS1oYXNrZWxsLWNhYmFsJywgJ2J1aWxkZXInKVxuICB9XG5cbiAgcHVibGljIHNldEVycm9ycyhzb3VyY2U6IHN0cmluZywgZXJyb3JzOiBJUmVzdWx0SXRlbVtdKSB7XG4gICAgdGhpcy5lcnJvcnMuc2V0KHNvdXJjZSwgdGhpcy5jb252ZXJ0KGVycm9ycykpXG4gICAgdGhpcy5zZW5kQWxsRXJyb3JzKClcbiAgfVxuXG4gIHB1YmxpYyBzZXRNZXNzYWdlcyhtZXNzYWdlczogSVJlc3VsdEl0ZW1bXSkge1xuICAgIGNvbnN0IGFsbCA9IHRoaXMuY29udmVydChtZXNzYWdlcylcbiAgICB0aGlzLm1lc3NhZ2VzID0gdGhpcy5tZXNzYWdlcy5maWx0ZXIoXG4gICAgICAoeyBfdGltZSB9KSA9PiBEYXRlLm5vdygpIC0gX3RpbWUgPCB0aGlzLm1heE1lc3NhZ2VUaW1lLFxuICAgIClcbiAgICB0aGlzLm1lc3NhZ2VzLnB1c2goLi4uYWxsLmZpbHRlcigoeyBzZXZlcml0eSB9KSA9PiBzZXZlcml0eSA9PT0gJ3JlcGwnKSlcbiAgICB0aGlzLnVwaVJlcGwuc2V0TWVzc2FnZXModGhpcy5tZXNzYWdlcylcbiAgfVxuXG4gIHByaXZhdGUgY29udmVydCh4czogSVJlc3VsdEl0ZW1bXSk6IElFcnJvckl0ZW1bXSB7XG4gICAgY29uc3QgX3RpbWUgPSBEYXRlLm5vdygpXG4gICAgcmV0dXJuIHhzLm1hcCgoeCkgPT4gKHsgLi4ueCwgX3RpbWUgfSkpXG4gIH1cblxuICBwcml2YXRlIHNlbmRBbGxFcnJvcnMoKSB7XG4gICAgbGV0IGVycm9yczogSUVycm9ySXRlbVtdID0gW11cbiAgICBmb3IgKGNvbnN0IFtzb3VyY2UsIGVycm9yQXJyXSBvZiB0aGlzLmVycm9ycy5lbnRyaWVzKCkpIHtcbiAgICAgIGlmIChcbiAgICAgICAgIWF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwtcmVwbC5jaGVja09uU2F2ZScpICYmXG4gICAgICAgIHNvdXJjZS5zdGFydHNXaXRoKCdiZzonKVxuICAgICAgKSB7XG4gICAgICAgIGNvbnRpbnVlXG4gICAgICB9XG4gICAgICBlcnJvcnMgPSBlcnJvcnMuZmlsdGVyKFxuICAgICAgICAoeCkgPT5cbiAgICAgICAgICAhZXJyb3JBcnIuc29tZShcbiAgICAgICAgICAgICh5KSA9PlxuICAgICAgICAgICAgICB4Ll90aW1lIDw9IHkuX3RpbWUgJiZcbiAgICAgICAgICAgICAgeC5jb250ZXh0ID09PSB5LmNvbnRleHQgJiZcbiAgICAgICAgICAgICAgY29tcGFyZU1lc3NhZ2UoeC5tZXNzYWdlLCB5Lm1lc3NhZ2UpICYmXG4gICAgICAgICAgICAgIGNvbXBhcmVQb3NpdGlvbih4LnBvc2l0aW9uLCB5LnBvc2l0aW9uKSAmJlxuICAgICAgICAgICAgICB4LnNldmVyaXR5ID09PSB5LnNldmVyaXR5LFxuICAgICAgICAgICksXG4gICAgICApXG4gICAgICBlcnJvcnMucHVzaCguLi5lcnJvckFycilcbiAgICB9XG4gICAgdGhpcy51cGlFcnJvcnMuc2V0TWVzc2FnZXMoZXJyb3JzKVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzaG91bGRTaG93VG9vbHRpcChcbiAgICBlZGl0b3I6IFRleHRFZGl0b3IsXG4gICAgY3JhbmdlOiBSYW5nZSxcbiAgICBfdHlwZTogc3RyaW5nLFxuICApIHtcbiAgICBpZiAoIWF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwtcmVwbC5zaG93VHlwZXMnKSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgIH1cbiAgICBjb25zdCBwYXRoID0gZWRpdG9yLmdldFBhdGgoKVxuICAgIGlmICghcGF0aCkgcmV0dXJuIHVuZGVmaW5lZFxuICAgIGNvbnN0IGJ1ZmZlciA9IGVkaXRvci5nZXRCdWZmZXIoKSAvLyBpbXBvcnRhbnQgdG8gYmluZCBiZWZvcmUgYXdhaXRcbiAgICBjb25zdCB7IGN3ZCwgY2FiYWwsIGNvbXAgfSA9IGF3YWl0IElkZUhhc2tlbGxSZXBsQmFzZS5jb21wb25lbnRGcm9tVVJJKHBhdGgpXG4gICAgY29uc3QgaGFzaCA9IGAke2N3ZC5nZXRQYXRoKCl9Ojoke2NhYmFsICYmIGNhYmFsLm5hbWV9Ojoke2NvbXAgJiYgY29tcFswXX1gXG4gICAgbGV0IGJnID0gdGhpcy5iZ0VkaXRvck1hcC5nZXQoaGFzaClcbiAgICBpZiAoIWJnKSBiZyA9IHRoaXMuY3JlYXRlTmV3QmdSZXBsKGhhc2gsIHBhdGgsIGJ1ZmZlcilcbiAgICByZXR1cm4gYmcuc2hvd1R5cGVBdChwYXRoLCBjcmFuZ2UpXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGRpZFNhdmVCdWZmZXIoYnVmZmVyOiBUZXh0QnVmZmVyKSB7XG4gICAgaWYgKFxuICAgICAgIWF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwtcmVwbC5jaGVja09uU2F2ZScpICYmXG4gICAgICAhYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1yZXBsLnNob3dUeXBlcycpXG4gICAgKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgY29uc3QgcGF0aCA9IGJ1ZmZlci5nZXRQYXRoKClcbiAgICBpZiAoIXBhdGgpIHJldHVyblxuICAgIGNvbnN0IHsgY3dkLCBjYWJhbCwgY29tcCB9ID0gYXdhaXQgSWRlSGFza2VsbFJlcGxCYXNlLmNvbXBvbmVudEZyb21VUkkocGF0aClcbiAgICBjb25zdCBoYXNoID0gYCR7Y3dkLmdldFBhdGgoKX06OiR7Y2FiYWwgJiYgY2FiYWwubmFtZX06OiR7Y29tcCAmJiBjb21wWzBdfWBcbiAgICBjb25zdCBiZ3QgPSB0aGlzLmJnRWRpdG9yTWFwLmdldChoYXNoKVxuICAgIGlmIChiZ3QpIHtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mbG9hdGluZy1wcm9taXNlc1xuICAgICAgYmd0LmdoY2lSZWxvYWQoKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmNyZWF0ZU5ld0JnUmVwbChoYXNoLCBwYXRoLCBidWZmZXIpXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVOZXdCZ1JlcGwoaGFzaDogc3RyaW5nLCBwYXRoOiBzdHJpbmcsIGJ1ZmZlcjogVGV4dEJ1ZmZlcikge1xuICAgIGNvbnN0IGJnID0gbmV3IElkZUhhc2tlbGxSZXBsQmcodGhpcywgeyB1cmk6IHBhdGggfSlcbiAgICB0aGlzLmJnRWRpdG9yTWFwLnNldChoYXNoLCBiZylcbiAgICBjb25zdCBkaXNwID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgIGRpc3AuYWRkKFxuICAgICAgbmV3IERpc3Bvc2FibGUoKCkgPT4ge1xuICAgICAgICB0aGlzLmRpc3Bvc2FibGVzLmRlbGV0ZShkaXNwKVxuICAgICAgICB0aGlzLmJnRWRpdG9yTWFwLmRlbGV0ZShoYXNoKVxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgICAgYmcuZGVzdHJveSgpXG4gICAgICB9KSxcbiAgICAgIGJ1ZmZlci5vbkRpZERlc3Ryb3koKCkgPT4gZGlzcC5kaXNwb3NlKCkpLFxuICAgIClcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChkaXNwKVxuICAgIHJldHVybiBiZ1xuICB9XG59XG5cbmZ1bmN0aW9uIGNvbXBhcmVQb3NpdGlvbih4PzogUG9pbnRDb21wYXRpYmxlLCB5PzogUG9pbnRDb21wYXRpYmxlKTogYm9vbGVhbiB7XG4gIGlmICh4ICYmIHkpIHtcbiAgICByZXR1cm4gUG9pbnQuZnJvbU9iamVjdCh4KS5pc0VxdWFsKHkpXG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHggPT09IHlcbiAgfVxufVxuXG5mdW5jdGlvbiBjb21wYXJlTWVzc2FnZShcbiAgeDogSUVycm9ySXRlbVsnbWVzc2FnZSddLFxuICB5OiBJRXJyb3JJdGVtWydtZXNzYWdlJ10sXG4pOiBib29sZWFuIHtcbiAgaWYgKHR5cGVvZiB4ID09PSAnc3RyaW5nJyAmJiB0eXBlb2YgeSA9PT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4geCA9PT0geVxuICB9IGVsc2UgaWYgKGlzVGV4dE1lc3NhZ2UoeCkgJiYgaXNUZXh0TWVzc2FnZSh5KSkge1xuICAgIHJldHVybiB4LnRleHQgPT09IHkudGV4dFxuICB9IGVsc2UgaWYgKGlzSFRNTE1lc3NhZ2UoeCkgJiYgaXNIVE1MTWVzc2FnZSh5KSkge1xuICAgIHJldHVybiB4Lmh0bWwgPT09IHkuaHRtbFxuICB9XG4gIHJldHVybiBmYWxzZVxufVxuXG5mdW5jdGlvbiBpc1RleHRNZXNzYWdlKHg6IElFcnJvckl0ZW1bJ21lc3NhZ2UnXSk6IHggaXMgSU1lc3NhZ2VUZXh0IHtcbiAgcmV0dXJuICh4IGFzIGFueSkudGV4dCAhPT0gdW5kZWZpbmVkXG59XG5cbmZ1bmN0aW9uIGlzSFRNTE1lc3NhZ2UoeDogSUVycm9ySXRlbVsnbWVzc2FnZSddKTogeCBpcyBJTWVzc2FnZUhUTUwge1xuICByZXR1cm4gKHggYXMgYW55KS50ZXh0ICE9PSB1bmRlZmluZWRcbn1cbiJdfQ==