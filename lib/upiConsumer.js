"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const ide_haskell_repl_base_1 = require("./ide-haskell-repl-base");
const ide_haskell_repl_bg_1 = require("./ide-haskell-repl-bg");
class UPIConsumer {
    constructor(register) {
        this.messages = [];
        this.errors = new Map();
        this.disposables = new atom_1.CompositeDisposable();
        this.maxMessageTime = 10000;
        this.bgEditorMap = new Map();
        this.disposables.add((this.upiRepl = register({
            name: 'ide-haskell-repl',
            messageTypes: {
                repl: {
                    uriFilter: false,
                    autoScroll: true,
                },
            },
            tooltip: this.shouldShowTooltip.bind(this),
            events: {
                onDidSaveBuffer: this.didSaveBuffer.bind(this),
            },
        })), (this.upiErrors = register({
            name: 'ide-haskell-repl::errors',
        })));
    }
    dispose() {
        this.disposables.dispose();
    }
    async getBuilder() {
        return this.upiRepl.getOthersConfigParam('ide-haskell-cabal', 'builder');
    }
    setErrors(source, errors) {
        this.errors.set(source, this.convert(errors));
        this.sendAllErrors();
    }
    setMessages(messages) {
        const all = this.convert(messages);
        this.messages = this.messages.filter(({ _time }) => Date.now() - _time < this.maxMessageTime);
        this.messages.push(...all.filter(({ severity }) => severity === 'repl'));
        this.upiRepl.setMessages(this.messages);
    }
    convert(xs) {
        const _time = Date.now();
        return xs.map((x) => (Object.assign({}, x, { _time })));
    }
    sendAllErrors() {
        let errors = [];
        for (const [source, errorArr] of this.errors.entries()) {
            if (!atom.config.get('ide-haskell-repl.checkOnSave') &&
                source.startsWith('bg:')) {
                continue;
            }
            errors = errors.filter((x) => !errorArr.some((y) => x._time <= y._time &&
                x.context === y.context &&
                compareMessage(x.message, y.message) &&
                comparePosition(x.position, y.position) &&
                x.severity === y.severity));
            errors.push(...errorArr);
        }
        this.upiErrors.setMessages(errors);
    }
    async shouldShowTooltip(editor, crange, _type) {
        if (!atom.config.get('ide-haskell-repl.showTypes')) {
            return undefined;
        }
        const path = editor.getPath();
        if (!path)
            return undefined;
        const buffer = editor.getBuffer();
        const { bg } = await this.getBgRepl(buffer);
        if (!bg)
            return undefined;
        return bg.showTypeAt(path, crange);
    }
    async didSaveBuffer(buffer) {
        if (!atom.config.get('ide-haskell-repl.checkOnSave') &&
            !atom.config.get('ide-haskell-repl.showTypes')) {
            return;
        }
        const { bg, isNew } = await this.getBgRepl(buffer);
        if (bg) {
            if (isNew)
                await bg.readyPromise;
            else
                await bg.ghciReload();
        }
    }
    async getBgRepl(buffer) {
        const path = buffer.getPath();
        if (!path)
            return { bg: undefined, isNew: false };
        const { cwd, cabal, comp } = await ide_haskell_repl_base_1.IdeHaskellReplBase.componentFromURI(path);
        const hash = `${cwd.getPath()}::${cabal && cabal.name}::${comp && comp[0]}`;
        let bgrec = this.bgEditorMap.get(hash);
        let isNew = false;
        if (!bgrec) {
            bgrec = this.createNewBgRepl(hash, path);
            isNew = true;
        }
        subscribeToBuffer(bgrec, buffer);
        return { bg: bgrec.bg, isNew };
    }
    createNewBgRepl(hash, path) {
        const bg = new ide_haskell_repl_bg_1.IdeHaskellReplBg(this, { uri: path });
        const bgrec = {
            bg,
            references: 0,
            buffers: new WeakSet(),
            disposables: new atom_1.CompositeDisposable(),
            dispose: () => {
                this.disposables.delete(bgrec);
                this.bgEditorMap.delete(hash);
                bgrec.bg.destroy();
                bgrec.disposables.dispose();
            },
        };
        this.disposables.add(bgrec);
        this.bgEditorMap.set(hash, bgrec);
        return bgrec;
    }
}
exports.UPIConsumer = UPIConsumer;
function subscribeToBuffer(rec, buffer) {
    if (rec.buffers.has(buffer))
        return;
    rec.references++;
    rec.buffers.add(buffer);
    rec.disposables.add(buffer.onDidDestroy(() => {
        rec.buffers.delete(buffer);
        rec.references--;
        if (rec.references === 0) {
            rec.dispose();
        }
    }));
}
function comparePosition(x, y) {
    if (x && y) {
        return atom_1.Point.fromObject(x).isEqual(y);
    }
    else {
        return x === y;
    }
}
function compareMessage(x, y) {
    if (typeof x === 'string' && typeof y === 'string') {
        return x === y;
    }
    else if (isTextMessage(x) && isTextMessage(y)) {
        return x.text === y.text;
    }
    else if (isHTMLMessage(x) && isHTMLMessage(y)) {
        return x.html === y.html;
    }
    return false;
}
function isTextMessage(x) {
    return x.text !== undefined;
}
function isHTMLMessage(x) {
    return x.text !== undefined;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBpQ29uc3VtZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXBpQ29uc3VtZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFPQSwrQkFPYTtBQUNiLG1FQUE0RDtBQUM1RCwrREFBd0Q7QUFjeEQ7SUFTRSxZQUFZLFFBQTBCO1FBTjlCLGFBQVEsR0FBaUIsRUFBRSxDQUFBO1FBQzNCLFdBQU0sR0FBOEIsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUM3QyxnQkFBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUN2QyxtQkFBYyxHQUFHLEtBQUssQ0FBQTtRQUN0QixnQkFBVyxHQUFHLElBQUksR0FBRyxFQUFpQixDQUFBO1FBRzVDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUNsQixDQUFDLElBQUksQ0FBQyxPQUFPLEdBQUcsUUFBUSxDQUFDO1lBQ3ZCLElBQUksRUFBRSxrQkFBa0I7WUFDeEIsWUFBWSxFQUFFO2dCQUNaLElBQUksRUFBRTtvQkFDSixTQUFTLEVBQUUsS0FBSztvQkFDaEIsVUFBVSxFQUFFLElBQUk7aUJBQ2pCO2FBQ0Y7WUFDRCxPQUFPLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDMUMsTUFBTSxFQUFFO2dCQUNOLGVBQWUsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7YUFDL0M7U0FDRixDQUFDLENBQUMsRUFDSCxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDO1lBQ3pCLElBQUksRUFBRSwwQkFBMEI7U0FDakMsQ0FBQyxDQUFDLENBQ0osQ0FBQTtJQUNILENBQUM7SUFFTSxPQUFPO1FBQ1osSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQTtJQUM1QixDQUFDO0lBRU0sS0FBSyxDQUFDLFVBQVU7UUFDckIsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsb0JBQW9CLENBRXJD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LFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDdkMsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ04sTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDaEIsQ0FBQztBQUNILENBQUM7QUFFRCx3QkFDRSxDQUF3QixFQUN4QixDQUF3QjtJQUV4QixFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxRQUFRLElBQUksT0FBTyxDQUFDLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQztRQUNuRCxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUNoQixDQUFDO0lBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsSUFBSSxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2hELE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUE7SUFDMUIsQ0FBQztJQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLElBQUksYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNoRCxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFBO0lBQzFCLENBQUM7SUFDRCxNQUFNLENBQUMsS0FBSyxDQUFBO0FBQ2QsQ0FBQztBQUVELHVCQUF1QixDQUF3QjtJQUM3QyxNQUFNLENBQUUsQ0FBUyxDQUFDLElBQUksS0FBSyxTQUFTLENBQUE7QUFDdEMsQ0FBQztBQUVELHVCQUF1QixDQUF3QjtJQUM3QyxNQUFNLENBQUUsQ0FBUyxDQUFDLElBQUksS0FBSyxTQUFTLENBQUE7QUFDdEMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIElVUElJbnN0YW5jZSxcbiAgSVJlc3VsdEl0ZW0sXG4gIElVUElSZWdpc3RyYXRpb24sXG4gIElNZXNzYWdlVGV4dCxcbiAgSU1lc3NhZ2VIVE1MLFxufSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xuaW1wb3J0IHtcbiAgQ29tcG9zaXRlRGlzcG9zYWJsZSxcbiAgVGV4dEVkaXRvcixcbiAgUmFuZ2UsXG4gIFRleHRCdWZmZXIsXG4gIFBvaW50LFxuICBQb2ludENvbXBhdGlibGUsXG59IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBJZGVIYXNrZWxsUmVwbEJhc2UgfSBmcm9tICcuL2lkZS1oYXNrZWxsLXJlcGwtYmFzZSdcbmltcG9ydCB7IElkZUhhc2tlbGxSZXBsQmcgfSBmcm9tICcuL2lkZS1oYXNrZWxsLXJlcGwtYmcnXG5cbmV4cG9ydCBpbnRlcmZhY2UgSUVycm9ySXRlbSBleHRlbmRzIElSZXN1bHRJdGVtIHtcbiAgX3RpbWU6IG51bWJlclxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEJnUmVjIHtcbiAgcmVmZXJlbmNlczogbnVtYmVyXG4gIGJnOiBJZGVIYXNrZWxsUmVwbEJnXG4gIGJ1ZmZlcnM6IFdlYWtTZXQ8VGV4dEJ1ZmZlcj5cbiAgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGVcbiAgZGlzcG9zZSgpOiB2b2lkXG59XG5cbmV4cG9ydCBjbGFzcyBVUElDb25zdW1lciB7XG4gIHByaXZhdGUgdXBpUmVwbDogSVVQSUluc3RhbmNlXG4gIHByaXZhdGUgdXBpRXJyb3JzOiBJVVBJSW5zdGFuY2VcbiAgcHJpdmF0ZSBtZXNzYWdlczogSUVycm9ySXRlbVtdID0gW11cbiAgcHJpdmF0ZSBlcnJvcnM6IE1hcDxzdHJpbmcsIElFcnJvckl0ZW1bXT4gPSBuZXcgTWFwKClcbiAgcHJpdmF0ZSBkaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgcHJpdmF0ZSBtYXhNZXNzYWdlVGltZSA9IDEwMDAwXG4gIHByaXZhdGUgYmdFZGl0b3JNYXAgPSBuZXcgTWFwPHN0cmluZywgQmdSZWM+KClcblxuICBjb25zdHJ1Y3RvcihyZWdpc3RlcjogSVVQSVJlZ2lzdHJhdGlvbikge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgKHRoaXMudXBpUmVwbCA9IHJlZ2lzdGVyKHtcbiAgICAgICAgbmFtZTogJ2lkZS1oYXNrZWxsLXJlcGwnLFxuICAgICAgICBtZXNzYWdlVHlwZXM6IHtcbiAgICAgICAgICByZXBsOiB7XG4gICAgICAgICAgICB1cmlGaWx0ZXI6IGZhbHNlLFxuICAgICAgICAgICAgYXV0b1Njcm9sbDogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB0b29sdGlwOiB0aGlzLnNob3VsZFNob3dUb29sdGlwLmJpbmQodGhpcyksXG4gICAgICAgIGV2ZW50czoge1xuICAgICAgICAgIG9uRGlkU2F2ZUJ1ZmZlcjogdGhpcy5kaWRTYXZlQnVmZmVyLmJpbmQodGhpcyksXG4gICAgICAgIH0sXG4gICAgICB9KSksXG4gICAgICAodGhpcy51cGlFcnJvcnMgPSByZWdpc3Rlcih7XG4gICAgICAgIG5hbWU6ICdpZGUtaGFza2VsbC1yZXBsOjplcnJvcnMnLFxuICAgICAgfSkpLFxuICAgIClcbiAgfVxuXG4gIHB1YmxpYyBkaXNwb3NlKCkge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0QnVpbGRlcigpIHtcbiAgICByZXR1cm4gdGhpcy51cGlSZXBsLmdldE90aGVyc0NvbmZpZ1BhcmFtPHtcbiAgICAgIG5hbWU6ICdjYWJhbCcgfCAnc3RhY2snIHwgJ2NhYmFsLW5peCcgfCAnbm9uZSdcbiAgICB9PignaWRlLWhhc2tlbGwtY2FiYWwnLCAnYnVpbGRlcicpXG4gIH1cblxuICBwdWJsaWMgc2V0RXJyb3JzKHNvdXJjZTogc3RyaW5nLCBlcnJvcnM6IElSZXN1bHRJdGVtW10pIHtcbiAgICB0aGlzLmVycm9ycy5zZXQoc291cmNlLCB0aGlzLmNvbnZlcnQoZXJyb3JzKSlcbiAgICB0aGlzLnNlbmRBbGxFcnJvcnMoKVxuICB9XG5cbiAgcHVibGljIHNldE1lc3NhZ2VzKG1lc3NhZ2VzOiBJUmVzdWx0SXRlbVtdKSB7XG4gICAgY29uc3QgYWxsID0gdGhpcy5jb252ZXJ0KG1lc3NhZ2VzKVxuICAgIHRoaXMubWVzc2FnZXMgPSB0aGlzLm1lc3NhZ2VzLmZpbHRlcihcbiAgICAgICh7IF90aW1lIH0pID0+IERhdGUubm93KCkgLSBfdGltZSA8IHRoaXMubWF4TWVzc2FnZVRpbWUsXG4gICAgKVxuICAgIHRoaXMubWVzc2FnZXMucHVzaCguLi5hbGwuZmlsdGVyKCh7IHNldmVyaXR5IH0pID0+IHNldmVyaXR5ID09PSAncmVwbCcpKVxuICAgIHRoaXMudXBpUmVwbC5zZXRNZXNzYWdlcyh0aGlzLm1lc3NhZ2VzKVxuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0KHhzOiBJUmVzdWx0SXRlbVtdKTogSUVycm9ySXRlbVtdIHtcbiAgICBjb25zdCBfdGltZSA9IERhdGUubm93KClcbiAgICByZXR1cm4geHMubWFwKCh4KSA9PiAoeyAuLi54LCBfdGltZSB9KSlcbiAgfVxuXG4gIHByaXZhdGUgc2VuZEFsbEVycm9ycygpIHtcbiAgICBsZXQgZXJyb3JzOiBJRXJyb3JJdGVtW10gPSBbXVxuICAgIGZvciAoY29uc3QgW3NvdXJjZSwgZXJyb3JBcnJdIG9mIHRoaXMuZXJyb3JzLmVudHJpZXMoKSkge1xuICAgICAgaWYgKFxuICAgICAgICAhYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1yZXBsLmNoZWNrT25TYXZlJykgJiZcbiAgICAgICAgc291cmNlLnN0YXJ0c1dpdGgoJ2JnOicpXG4gICAgICApIHtcbiAgICAgICAgY29udGludWVcbiAgICAgIH1cbiAgICAgIGVycm9ycyA9IGVycm9ycy5maWx0ZXIoXG4gICAgICAgICh4KSA9PlxuICAgICAgICAgICFlcnJvckFyci5zb21lKFxuICAgICAgICAgICAgKHkpID0+XG4gICAgICAgICAgICAgIHguX3RpbWUgPD0geS5fdGltZSAmJlxuICAgICAgICAgICAgICB4LmNvbnRleHQgPT09IHkuY29udGV4dCAmJlxuICAgICAgICAgICAgICBjb21wYXJlTWVzc2FnZSh4Lm1lc3NhZ2UsIHkubWVzc2FnZSkgJiZcbiAgICAgICAgICAgICAgY29tcGFyZVBvc2l0aW9uKHgucG9zaXRpb24sIHkucG9zaXRpb24pICYmXG4gICAgICAgICAgICAgIHguc2V2ZXJpdHkgPT09IHkuc2V2ZXJpdHksXG4gICAgICAgICAgKSxcbiAgICAgIClcbiAgICAgIGVycm9ycy5wdXNoKC4uLmVycm9yQXJyKVxuICAgIH1cbiAgICB0aGlzLnVwaUVycm9ycy5zZXRNZXNzYWdlcyhlcnJvcnMpXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNob3VsZFNob3dUb29sdGlwKFxuICAgIGVkaXRvcjogVGV4dEVkaXRvcixcbiAgICBjcmFuZ2U6IFJhbmdlLFxuICAgIF90eXBlOiBzdHJpbmcsXG4gICkge1xuICAgIGlmICghYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1yZXBsLnNob3dUeXBlcycpKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkXG4gICAgfVxuICAgIGNvbnN0IHBhdGggPSBlZGl0b3IuZ2V0UGF0aCgpXG4gICAgaWYgKCFwYXRoKSByZXR1cm4gdW5kZWZpbmVkXG4gICAgY29uc3QgYnVmZmVyID0gZWRpdG9yLmdldEJ1ZmZlcigpXG4gICAgY29uc3QgeyBiZyB9ID0gYXdhaXQgdGhpcy5nZXRCZ1JlcGwoYnVmZmVyKVxuICAgIGlmICghYmcpIHJldHVybiB1bmRlZmluZWRcbiAgICByZXR1cm4gYmcuc2hvd1R5cGVBdChwYXRoLCBjcmFuZ2UpXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGRpZFNhdmVCdWZmZXIoYnVmZmVyOiBUZXh0QnVmZmVyKSB7XG4gICAgaWYgKFxuICAgICAgIWF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwtcmVwbC5jaGVja09uU2F2ZScpICYmXG4gICAgICAhYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1yZXBsLnNob3dUeXBlcycpXG4gICAgKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgY29uc3QgeyBiZywgaXNOZXcgfSA9IGF3YWl0IHRoaXMuZ2V0QmdSZXBsKGJ1ZmZlcilcbiAgICBpZiAoYmcpIHtcbiAgICAgIC8vIG5vIG5lZWQgdG8gcmVsb2FkIG5ld2x5IGNyZWF0ZWQgaW5zdGFuY2Ugc2luY2UgaXQgcmVsb2FkcyBvbiBzdGFydFxuICAgICAgaWYgKGlzTmV3KSBhd2FpdCBiZy5yZWFkeVByb21pc2VcbiAgICAgIGVsc2UgYXdhaXQgYmcuZ2hjaVJlbG9hZCgpXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRCZ1JlcGwoYnVmZmVyOiBUZXh0QnVmZmVyKSB7XG4gICAgY29uc3QgcGF0aCA9IGJ1ZmZlci5nZXRQYXRoKClcbiAgICBpZiAoIXBhdGgpIHJldHVybiB7IGJnOiB1bmRlZmluZWQsIGlzTmV3OiBmYWxzZSB9XG4gICAgY29uc3QgeyBjd2QsIGNhYmFsLCBjb21wIH0gPSBhd2FpdCBJZGVIYXNrZWxsUmVwbEJhc2UuY29tcG9uZW50RnJvbVVSSShwYXRoKVxuICAgIGNvbnN0IGhhc2ggPSBgJHtjd2QuZ2V0UGF0aCgpfTo6JHtjYWJhbCAmJiBjYWJhbC5uYW1lfTo6JHtjb21wICYmIGNvbXBbMF19YFxuICAgIGxldCBiZ3JlYyA9IHRoaXMuYmdFZGl0b3JNYXAuZ2V0KGhhc2gpXG4gICAgbGV0IGlzTmV3ID0gZmFsc2VcbiAgICBpZiAoIWJncmVjKSB7XG4gICAgICBiZ3JlYyA9IHRoaXMuY3JlYXRlTmV3QmdSZXBsKGhhc2gsIHBhdGgpXG4gICAgICBpc05ldyA9IHRydWVcbiAgICB9XG4gICAgc3Vic2NyaWJlVG9CdWZmZXIoYmdyZWMsIGJ1ZmZlcilcbiAgICByZXR1cm4geyBiZzogYmdyZWMuYmcsIGlzTmV3IH1cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlTmV3QmdSZXBsKGhhc2g6IHN0cmluZywgcGF0aDogc3RyaW5nKSB7XG4gICAgY29uc3QgYmcgPSBuZXcgSWRlSGFza2VsbFJlcGxCZyh0aGlzLCB7IHVyaTogcGF0aCB9KVxuICAgIGNvbnN0IGJncmVjOiBCZ1JlYyA9IHtcbiAgICAgIGJnLFxuICAgICAgcmVmZXJlbmNlczogMCxcbiAgICAgIGJ1ZmZlcnM6IG5ldyBXZWFrU2V0KCksXG4gICAgICBkaXNwb3NhYmxlczogbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKSxcbiAgICAgIGRpc3Bvc2U6ICgpID0+IHtcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlcy5kZWxldGUoYmdyZWMpXG4gICAgICAgIHRoaXMuYmdFZGl0b3JNYXAuZGVsZXRlKGhhc2gpXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mbG9hdGluZy1wcm9taXNlc1xuICAgICAgICBiZ3JlYy5iZy5kZXN0cm95KClcbiAgICAgICAgYmdyZWMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gICAgICB9LFxuICAgIH1cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChiZ3JlYylcbiAgICB0aGlzLmJnRWRpdG9yTWFwLnNldChoYXNoLCBiZ3JlYylcbiAgICByZXR1cm4gYmdyZWNcbiAgfVxufVxuXG5mdW5jdGlvbiBzdWJzY3JpYmVUb0J1ZmZlcihyZWM6IEJnUmVjLCBidWZmZXI6IFRleHRCdWZmZXIpIHtcbiAgaWYgKHJlYy5idWZmZXJzLmhhcyhidWZmZXIpKSByZXR1cm5cbiAgcmVjLnJlZmVyZW5jZXMrK1xuICByZWMuYnVmZmVycy5hZGQoYnVmZmVyKVxuICByZWMuZGlzcG9zYWJsZXMuYWRkKFxuICAgIGJ1ZmZlci5vbkRpZERlc3Ryb3koKCkgPT4ge1xuICAgICAgcmVjLmJ1ZmZlcnMuZGVsZXRlKGJ1ZmZlcilcbiAgICAgIHJlYy5yZWZlcmVuY2VzLS1cbiAgICAgIGlmIChyZWMucmVmZXJlbmNlcyA9PT0gMCkge1xuICAgICAgICByZWMuZGlzcG9zZSgpXG4gICAgICB9XG4gICAgfSksXG4gIClcbn1cblxuZnVuY3Rpb24gY29tcGFyZVBvc2l0aW9uKHg/OiBQb2ludENvbXBhdGlibGUsIHk/OiBQb2ludENvbXBhdGlibGUpOiBib29sZWFuIHtcbiAgaWYgKHggJiYgeSkge1xuICAgIHJldHVybiBQb2ludC5mcm9tT2JqZWN0KHgpLmlzRXF1YWwoeSlcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4geCA9PT0geVxuICB9XG59XG5cbmZ1bmN0aW9uIGNvbXBhcmVNZXNzYWdlKFxuICB4OiBJRXJyb3JJdGVtWydtZXNzYWdlJ10sXG4gIHk6IElFcnJvckl0ZW1bJ21lc3NhZ2UnXSxcbik6IGJvb2xlYW4ge1xuICBpZiAodHlwZW9mIHggPT09ICdzdHJpbmcnICYmIHR5cGVvZiB5ID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiB4ID09PSB5XG4gIH0gZWxzZSBpZiAoaXNUZXh0TWVzc2FnZSh4KSAmJiBpc1RleHRNZXNzYWdlKHkpKSB7XG4gICAgcmV0dXJuIHgudGV4dCA9PT0geS50ZXh0XG4gIH0gZWxzZSBpZiAoaXNIVE1MTWVzc2FnZSh4KSAmJiBpc0hUTUxNZXNzYWdlKHkpKSB7XG4gICAgcmV0dXJuIHguaHRtbCA9PT0geS5odG1sXG4gIH1cbiAgcmV0dXJuIGZhbHNlXG59XG5cbmZ1bmN0aW9uIGlzVGV4dE1lc3NhZ2UoeDogSUVycm9ySXRlbVsnbWVzc2FnZSddKTogeCBpcyBJTWVzc2FnZVRleHQge1xuICByZXR1cm4gKHggYXMgYW55KS50ZXh0ICE9PSB1bmRlZmluZWRcbn1cblxuZnVuY3Rpb24gaXNIVE1MTWVzc2FnZSh4OiBJRXJyb3JJdGVtWydtZXNzYWdlJ10pOiB4IGlzIElNZXNzYWdlSFRNTCB7XG4gIHJldHVybiAoeCBhcyBhbnkpLnRleHQgIT09IHVuZGVmaW5lZFxufVxuIl19