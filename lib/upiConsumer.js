"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const ide_haskell_repl_base_1 = require("./ide-haskell-repl-base");
const ide_haskell_repl_bg_1 = require("./ide-haskell-repl-bg");
class UPIConsumer {
    constructor(register) {
        this.messages = [];
        this.errors = new Map();
        this.disposables = new atom_1.CompositeDisposable();
        this.maxMessageTime = 10000;
        this.bgEditorMap = new Map();
        this.disposables.add((this.upiRepl = register({
            name: 'ide-haskell-repl',
            messageTypes: {
                repl: {
                    uriFilter: false,
                    autoScroll: true,
                },
            },
            tooltip: this.shouldShowTooltip.bind(this),
            events: {
                onDidSaveBuffer: this.didSaveBuffer.bind(this),
            },
        })), (this.upiErrors = register({
            name: 'ide-haskell-repl::errors',
        })));
    }
    dispose() {
        for (const proc of this.bgEditorMap.values()) {
            proc.destroy();
        }
        this.bgEditorMap.clear();
        this.disposables.dispose();
    }
    async getBuilder() {
        return this.upiRepl.getOthersConfigParam('ide-haskell-cabal', 'builder');
    }
    setErrors(source, errors) {
        this.errors.set(source, this.convert(errors));
        this.sendAllErrors();
    }
    setMessages(messages) {
        const all = this.convert(messages);
        this.messages = this.messages.filter(({ _time }) => Date.now() - _time < this.maxMessageTime);
        this.messages.push(...all.filter(({ severity }) => severity === 'repl'));
        this.upiRepl.setMessages(this.messages);
    }
    convert(xs) {
        const _time = Date.now();
        return xs.map((x) => (Object.assign({}, x, { _time })));
    }
    sendAllErrors() {
        let errors = [];
        for (const [source, errorArr] of this.errors.entries()) {
            if (!atom.config.get('ide-haskell-repl.checkOnSave') &&
                source.startsWith('bg:')) {
                continue;
            }
            errors = errors.filter((x) => !errorArr.some((y) => x._time <= y._time &&
                x.context === y.context &&
                compareMessage(x.message, y.message) &&
                comparePosition(x.position, y.position) &&
                x.severity === y.severity));
            errors.push(...errorArr);
        }
        this.upiErrors.setMessages(errors);
    }
    async shouldShowTooltip(editor, crange, _type) {
        if (!atom.config.get('ide-haskell-repl.showTypes')) {
            return undefined;
        }
        const path = editor.getPath();
        if (!path)
            return undefined;
        const buffer = editor.getBuffer();
        const { cwd, cabal, comp } = await ide_haskell_repl_base_1.IdeHaskellReplBase.componentFromURI(path);
        const hash = `${cwd.getPath()}::${cabal && cabal.name}::${comp && comp[0]}`;
        let bg = this.bgEditorMap.get(hash);
        if (!bg)
            bg = await this.createNewBgRepl(hash, path, buffer);
        return bg.showTypeAt(path, crange);
    }
    async didSaveBuffer(buffer) {
        if (!atom.config.get('ide-haskell-repl.checkOnSave') &&
            !atom.config.get('ide-haskell-repl.showTypes')) {
            return;
        }
        const path = buffer.getPath();
        if (!path)
            return;
        const { cwd, cabal, comp } = await ide_haskell_repl_base_1.IdeHaskellReplBase.componentFromURI(path);
        const hash = `${cwd.getPath()}::${cabal && cabal.name}::${comp && comp[0]}`;
        const bgt = this.bgEditorMap.get(hash);
        if (bgt) {
            await bgt.ghciReload();
        }
        else if (atom.config.get('ide-haskell-repl.checkOnSave')) {
            await this.createNewBgRepl(hash, path, buffer);
        }
    }
    async createNewBgRepl(hash, path, buffer) {
        const bg = new ide_haskell_repl_bg_1.IdeHaskellReplBg(this, { uri: path });
        this.bgEditorMap.set(hash, bg);
        const disp = new atom_1.CompositeDisposable();
        disp.add(new atom_1.Disposable(() => {
            this.disposables.delete(disp);
            this.bgEditorMap.delete(hash);
            bg.destroy();
        }), buffer.onDidDestroy(() => disp.dispose()));
        this.disposables.add(disp);
        await bg.readyPromise;
        return bg;
    }
}
exports.UPIConsumer = UPIConsumer;
function comparePosition(x, y) {
    if (x && y) {
        return atom_1.Point.fromObject(x).isEqual(y);
    }
    else {
        return x === y;
    }
}
function compareMessage(x, y) {
    if (typeof x === 'string' && typeof y === 'string') {
        return x === y;
    }
    else if (isTextMessage(x) && isTextMessage(y)) {
        return x.text === y.text;
    }
    else if (isHTMLMessage(x) && isHTMLMessage(y)) {
        return x.html === y.html;
    }
    return false;
}
function isTextMessage(x) {
    return x.text !== undefined;
}
function isHTMLMessage(x) {
    return x.text !== undefined;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBpQ29uc3VtZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXBpQ29uc3VtZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFPQSwrQkFRYTtBQUNiLG1FQUE0RDtBQUM1RCwrREFBd0Q7QUFNeEQ7SUFTRSxZQUFZLFFBQTBCO1FBTjlCLGFBQVEsR0FBaUIsRUFBRSxDQUFBO1FBQzNCLFdBQU0sR0FBOEIsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUM3QyxnQkFBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUN2QyxtQkFBYyxHQUFHLEtBQUssQ0FBQTtRQUN0QixnQkFBVyxHQUFHLElBQUksR0FBRyxFQUE0QixDQUFBO1FBR3ZELElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUNsQixDQUFDLElBQUksQ0FBQyxPQUFPLEdBQUcsUUFBUSxDQUFDO1lBQ3ZCLElBQUksRUFBRSxrQkFBa0I7WUFDeEIsWUFBWSxFQUFFO2dCQUNaLElBQUksRUFBRTtvQkFDSixTQUFTLEVBQUUsS0FBSztvQkFDaEIsVUFBVSxFQUFFLElBQUk7aUJBQ2pCO2FBQ0Y7WUFDRCxPQUFPLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDMUMsTUFBTSxFQUFFO2dCQUNOLGVBQWUsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7YUFDL0M7U0FDRixDQUFDLENBQUMsRUFDSCxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDO1lBQ3pCLElBQUksRUFBRSwwQkFBMEI7U0FDakMsQ0FBQyxDQUFDLENBQ0osQ0FBQTtJQUNILENBQUM7SUFFTSxPQUFPO1FBQ1osR0FBRyxDQUFDLENBQUMsTUFBTSxJQUFJLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFFN0MsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFBO1FBQ2hCLENB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QU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUE7SUFDMUIsQ0FBQztJQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLElBQUksYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNoRCxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFBO0lBQzFCLENBQUM7SUFDRCxNQUFNLENBQUMsS0FBSyxDQUFBO0FBQ2QsQ0FBQztBQUVELHVCQUF1QixDQUF3QjtJQUM3QyxNQUFNLENBQUUsQ0FBUyxDQUFDLElBQUksS0FBSyxTQUFTLENBQUE7QUFDdEMsQ0FBQztBQUVELHVCQUF1QixDQUF3QjtJQUM3QyxNQUFNLENBQUUsQ0FBUyxDQUFDLElBQUksS0FBSyxTQUFTLENBQUE7QUFDdEMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIElVUElJbnN0YW5jZSxcbiAgSVJlc3VsdEl0ZW0sXG4gIElVUElSZWdpc3RyYXRpb24sXG4gIElNZXNzYWdlVGV4dCxcbiAgSU1lc3NhZ2VIVE1MLFxufSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xuaW1wb3J0IHtcbiAgQ29tcG9zaXRlRGlzcG9zYWJsZSxcbiAgVGV4dEVkaXRvcixcbiAgUmFuZ2UsXG4gIFRleHRCdWZmZXIsXG4gIERpc3Bvc2FibGUsXG4gIFBvaW50LFxuICBQb2ludENvbXBhdGlibGUsXG59IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBJZGVIYXNrZWxsUmVwbEJhc2UgfSBmcm9tICcuL2lkZS1oYXNrZWxsLXJlcGwtYmFzZSdcbmltcG9ydCB7IElkZUhhc2tlbGxSZXBsQmcgfSBmcm9tICcuL2lkZS1oYXNrZWxsLXJlcGwtYmcnXG5cbmV4cG9ydCBpbnRlcmZhY2UgSUVycm9ySXRlbSBleHRlbmRzIElSZXN1bHRJdGVtIHtcbiAgX3RpbWU6IG51bWJlclxufVxuXG5leHBvcnQgY2xhc3MgVVBJQ29uc3VtZXIge1xuICBwcml2YXRlIHVwaVJlcGw6IElVUElJbnN0YW5jZVxuICBwcml2YXRlIHVwaUVycm9yczogSVVQSUluc3RhbmNlXG4gIHByaXZhdGUgbWVzc2FnZXM6IElFcnJvckl0ZW1bXSA9IFtdXG4gIHByaXZhdGUgZXJyb3JzOiBNYXA8c3RyaW5nLCBJRXJyb3JJdGVtW10+ID0gbmV3IE1hcCgpXG4gIHByaXZhdGUgZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIHByaXZhdGUgbWF4TWVzc2FnZVRpbWUgPSAxMDAwMFxuICBwcml2YXRlIGJnRWRpdG9yTWFwID0gbmV3IE1hcDxzdHJpbmcsIElkZUhhc2tlbGxSZXBsQmc+KClcblxuICBjb25zdHJ1Y3RvcihyZWdpc3RlcjogSVVQSVJlZ2lzdHJhdGlvbikge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgKHRoaXMudXBpUmVwbCA9IHJlZ2lzdGVyKHtcbiAgICAgICAgbmFtZTogJ2lkZS1oYXNrZWxsLXJlcGwnLFxuICAgICAgICBtZXNzYWdlVHlwZXM6IHtcbiAgICAgICAgICByZXBsOiB7XG4gICAgICAgICAgICB1cmlGaWx0ZXI6IGZhbHNlLFxuICAgICAgICAgICAgYXV0b1Njcm9sbDogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB0b29sdGlwOiB0aGlzLnNob3VsZFNob3dUb29sdGlwLmJpbmQodGhpcyksXG4gICAgICAgIGV2ZW50czoge1xuICAgICAgICAgIG9uRGlkU2F2ZUJ1ZmZlcjogdGhpcy5kaWRTYXZlQnVmZmVyLmJpbmQodGhpcyksXG4gICAgICAgIH0sXG4gICAgICB9KSksXG4gICAgICAodGhpcy51cGlFcnJvcnMgPSByZWdpc3Rlcih7XG4gICAgICAgIG5hbWU6ICdpZGUtaGFza2VsbC1yZXBsOjplcnJvcnMnLFxuICAgICAgfSkpLFxuICAgIClcbiAgfVxuXG4gIHB1YmxpYyBkaXNwb3NlKCkge1xuICAgIGZvciAoY29uc3QgcHJvYyBvZiB0aGlzLmJnRWRpdG9yTWFwLnZhbHVlcygpKSB7XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgIHByb2MuZGVzdHJveSgpXG4gICAgfVxuICAgIHRoaXMuYmdFZGl0b3JNYXAuY2xlYXIoKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0QnVpbGRlcigpIHtcbiAgICByZXR1cm4gdGhpcy51cGlSZXBsLmdldE90aGVyc0NvbmZpZ1BhcmFtPHtcbiAgICAgIG5hbWU6ICdjYWJhbCcgfCAnc3RhY2snIHwgJ2NhYmFsLW5peCcgfCAnbm9uZSdcbiAgICB9PignaWRlLWhhc2tlbGwtY2FiYWwnLCAnYnVpbGRlcicpXG4gIH1cblxuICBwdWJsaWMgc2V0RXJyb3JzKHNvdXJjZTogc3RyaW5nLCBlcnJvcnM6IElSZXN1bHRJdGVtW10pIHtcbiAgICB0aGlzLmVycm9ycy5zZXQoc291cmNlLCB0aGlzLmNvbnZlcnQoZXJyb3JzKSlcbiAgICB0aGlzLnNlbmRBbGxFcnJvcnMoKVxuICB9XG5cbiAgcHVibGljIHNldE1lc3NhZ2VzKG1lc3NhZ2VzOiBJUmVzdWx0SXRlbVtdKSB7XG4gICAgY29uc3QgYWxsID0gdGhpcy5jb252ZXJ0KG1lc3NhZ2VzKVxuICAgIHRoaXMubWVzc2FnZXMgPSB0aGlzLm1lc3NhZ2VzLmZpbHRlcihcbiAgICAgICh7IF90aW1lIH0pID0+IERhdGUubm93KCkgLSBfdGltZSA8IHRoaXMubWF4TWVzc2FnZVRpbWUsXG4gICAgKVxuICAgIHRoaXMubWVzc2FnZXMucHVzaCguLi5hbGwuZmlsdGVyKCh7IHNldmVyaXR5IH0pID0+IHNldmVyaXR5ID09PSAncmVwbCcpKVxuICAgIHRoaXMudXBpUmVwbC5zZXRNZXNzYWdlcyh0aGlzLm1lc3NhZ2VzKVxuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0KHhzOiBJUmVzdWx0SXRlbVtdKTogSUVycm9ySXRlbVtdIHtcbiAgICBjb25zdCBfdGltZSA9IERhdGUubm93KClcbiAgICByZXR1cm4geHMubWFwKCh4KSA9PiAoeyAuLi54LCBfdGltZSB9KSlcbiAgfVxuXG4gIHByaXZhdGUgc2VuZEFsbEVycm9ycygpIHtcbiAgICBsZXQgZXJyb3JzOiBJRXJyb3JJdGVtW10gPSBbXVxuICAgIGZvciAoY29uc3QgW3NvdXJjZSwgZXJyb3JBcnJdIG9mIHRoaXMuZXJyb3JzLmVudHJpZXMoKSkge1xuICAgICAgaWYgKFxuICAgICAgICAhYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1yZXBsLmNoZWNrT25TYXZlJykgJiZcbiAgICAgICAgc291cmNlLnN0YXJ0c1dpdGgoJ2JnOicpXG4gICAgICApIHtcbiAgICAgICAgY29udGludWVcbiAgICAgIH1cbiAgICAgIGVycm9ycyA9IGVycm9ycy5maWx0ZXIoXG4gICAgICAgICh4KSA9PlxuICAgICAgICAgICFlcnJvckFyci5zb21lKFxuICAgICAgICAgICAgKHkpID0+XG4gICAgICAgICAgICAgIHguX3RpbWUgPD0geS5fdGltZSAmJlxuICAgICAgICAgICAgICB4LmNvbnRleHQgPT09IHkuY29udGV4dCAmJlxuICAgICAgICAgICAgICBjb21wYXJlTWVzc2FnZSh4Lm1lc3NhZ2UsIHkubWVzc2FnZSkgJiZcbiAgICAgICAgICAgICAgY29tcGFyZVBvc2l0aW9uKHgucG9zaXRpb24sIHkucG9zaXRpb24pICYmXG4gICAgICAgICAgICAgIHguc2V2ZXJpdHkgPT09IHkuc2V2ZXJpdHksXG4gICAgICAgICAgKSxcbiAgICAgIClcbiAgICAgIGVycm9ycy5wdXNoKC4uLmVycm9yQXJyKVxuICAgIH1cbiAgICB0aGlzLnVwaUVycm9ycy5zZXRNZXNzYWdlcyhlcnJvcnMpXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNob3VsZFNob3dUb29sdGlwKFxuICAgIGVkaXRvcjogVGV4dEVkaXRvcixcbiAgICBjcmFuZ2U6IFJhbmdlLFxuICAgIF90eXBlOiBzdHJpbmcsXG4gICkge1xuICAgIGlmICghYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1yZXBsLnNob3dUeXBlcycpKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkXG4gICAgfVxuICAgIGNvbnN0IHBhdGggPSBlZGl0b3IuZ2V0UGF0aCgpXG4gICAgaWYgKCFwYXRoKSByZXR1cm4gdW5kZWZpbmVkXG4gICAgY29uc3QgYnVmZmVyID0gZWRpdG9yLmdldEJ1ZmZlcigpIC8vIGltcG9ydGFudCB0byBiaW5kIGJlZm9yZSBhd2FpdFxuICAgIGNvbnN0IHsgY3dkLCBjYWJhbCwgY29tcCB9ID0gYXdhaXQgSWRlSGFza2VsbFJlcGxCYXNlLmNvbXBvbmVudEZyb21VUkkocGF0aClcbiAgICBjb25zdCBoYXNoID0gYCR7Y3dkLmdldFBhdGgoKX06OiR7Y2FiYWwgJiYgY2FiYWwubmFtZX06OiR7Y29tcCAmJiBjb21wWzBdfWBcbiAgICBsZXQgYmcgPSB0aGlzLmJnRWRpdG9yTWFwLmdldChoYXNoKVxuICAgIGlmICghYmcpIGJnID0gYXdhaXQgdGhpcy5jcmVhdGVOZXdCZ1JlcGwoaGFzaCwgcGF0aCwgYnVmZmVyKVxuICAgIHJldHVybiBiZy5zaG93VHlwZUF0KHBhdGgsIGNyYW5nZSlcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZGlkU2F2ZUJ1ZmZlcihidWZmZXI6IFRleHRCdWZmZXIpIHtcbiAgICBpZiAoXG4gICAgICAhYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1yZXBsLmNoZWNrT25TYXZlJykgJiZcbiAgICAgICFhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLXJlcGwuc2hvd1R5cGVzJylcbiAgICApIHtcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICBjb25zdCBwYXRoID0gYnVmZmVyLmdldFBhdGgoKVxuICAgIGlmICghcGF0aCkgcmV0dXJuXG4gICAgY29uc3QgeyBjd2QsIGNhYmFsLCBjb21wIH0gPSBhd2FpdCBJZGVIYXNrZWxsUmVwbEJhc2UuY29tcG9uZW50RnJvbVVSSShwYXRoKVxuICAgIGNvbnN0IGhhc2ggPSBgJHtjd2QuZ2V0UGF0aCgpfTo6JHtjYWJhbCAmJiBjYWJhbC5uYW1lfTo6JHtjb21wICYmIGNvbXBbMF19YFxuICAgIGNvbnN0IGJndCA9IHRoaXMuYmdFZGl0b3JNYXAuZ2V0KGhhc2gpXG4gICAgaWYgKGJndCkge1xuICAgICAgYXdhaXQgYmd0LmdoY2lSZWxvYWQoKVxuICAgIH0gZWxzZSBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1yZXBsLmNoZWNrT25TYXZlJykpIHtcbiAgICAgIGF3YWl0IHRoaXMuY3JlYXRlTmV3QmdSZXBsKGhhc2gsIHBhdGgsIGJ1ZmZlcilcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNyZWF0ZU5ld0JnUmVwbChcbiAgICBoYXNoOiBzdHJpbmcsXG4gICAgcGF0aDogc3RyaW5nLFxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlcixcbiAgKSB7XG4gICAgY29uc3QgYmcgPSBuZXcgSWRlSGFza2VsbFJlcGxCZyh0aGlzLCB7IHVyaTogcGF0aCB9KVxuICAgIHRoaXMuYmdFZGl0b3JNYXAuc2V0KGhhc2gsIGJnKVxuICAgIGNvbnN0IGRpc3AgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgZGlzcC5hZGQoXG4gICAgICBuZXcgRGlzcG9zYWJsZSgoKSA9PiB7XG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZXMuZGVsZXRlKGRpc3ApXG4gICAgICAgIHRoaXMuYmdFZGl0b3JNYXAuZGVsZXRlKGhhc2gpXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mbG9hdGluZy1wcm9taXNlc1xuICAgICAgICBiZy5kZXN0cm95KClcbiAgICAgIH0pLFxuICAgICAgYnVmZmVyLm9uRGlkRGVzdHJveSgoKSA9PiBkaXNwLmRpc3Bvc2UoKSksXG4gICAgKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGRpc3ApXG4gICAgYXdhaXQgYmcucmVhZHlQcm9taXNlXG4gICAgcmV0dXJuIGJnXG4gIH1cbn1cblxuZnVuY3Rpb24gY29tcGFyZVBvc2l0aW9uKHg/OiBQb2ludENvbXBhdGlibGUsIHk/OiBQb2ludENvbXBhdGlibGUpOiBib29sZWFuIHtcbiAgaWYgKHggJiYgeSkge1xuICAgIHJldHVybiBQb2ludC5mcm9tT2JqZWN0KHgpLmlzRXF1YWwoeSlcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4geCA9PT0geVxuICB9XG59XG5cbmZ1bmN0aW9uIGNvbXBhcmVNZXNzYWdlKFxuICB4OiBJRXJyb3JJdGVtWydtZXNzYWdlJ10sXG4gIHk6IElFcnJvckl0ZW1bJ21lc3NhZ2UnXSxcbik6IGJvb2xlYW4ge1xuICBpZiAodHlwZW9mIHggPT09ICdzdHJpbmcnICYmIHR5cGVvZiB5ID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiB4ID09PSB5XG4gIH0gZWxzZSBpZiAoaXNUZXh0TWVzc2FnZSh4KSAmJiBpc1RleHRNZXNzYWdlKHkpKSB7XG4gICAgcmV0dXJuIHgudGV4dCA9PT0geS50ZXh0XG4gIH0gZWxzZSBpZiAoaXNIVE1MTWVzc2FnZSh4KSAmJiBpc0hUTUxNZXNzYWdlKHkpKSB7XG4gICAgcmV0dXJuIHguaHRtbCA9PT0geS5odG1sXG4gIH1cbiAgcmV0dXJuIGZhbHNlXG59XG5cbmZ1bmN0aW9uIGlzVGV4dE1lc3NhZ2UoeDogSUVycm9ySXRlbVsnbWVzc2FnZSddKTogeCBpcyBJTWVzc2FnZVRleHQge1xuICByZXR1cm4gKHggYXMgYW55KS50ZXh0ICE9PSB1bmRlZmluZWRcbn1cblxuZnVuY3Rpb24gaXNIVE1MTWVzc2FnZSh4OiBJRXJyb3JJdGVtWydtZXNzYWdlJ10pOiB4IGlzIElNZXNzYWdlSFRNTCB7XG4gIHJldHVybiAoeCBhcyBhbnkpLnRleHQgIT09IHVuZGVmaW5lZFxufVxuIl19