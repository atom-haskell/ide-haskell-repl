"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const ide_haskell_repl_base_1 = require("./ide-haskell-repl-base");
const ide_haskell_repl_bg_1 = require("./ide-haskell-repl-bg");
class UPIConsumer {
    constructor(register) {
        this.messages = [];
        this.errors = new Map();
        this.disposables = new atom_1.CompositeDisposable();
        this.maxMessageTime = 10000;
        this.bgEditorMap = new Map();
        this.disposables.add((this.upiRepl = register({
            name: 'ide-haskell-repl',
            messageTypes: {
                repl: {
                    uriFilter: false,
                    autoScroll: true,
                },
            },
            tooltip: this.shouldShowTooltip.bind(this),
            events: {
                onDidSaveBuffer: this.didSaveBuffer.bind(this),
            },
        })), (this.upiErrors = register({
            name: 'ide-haskell-repl::errors',
        })));
    }
    dispose() {
        this.disposables.dispose();
    }
    async getBuilder() {
        const builder = await this.upiRepl.getOthersConfigParam('ide-haskell-cabal', 'builder');
        switch (builder && builder.name) {
            case 'cabal':
                builder.name = 'cabal-v1';
                break;
            case 'cabal-nix':
                builder.name = 'cabal-v2';
                break;
        }
        return builder;
    }
    setErrors(source, errors) {
        this.errors.set(source, this.convert(errors));
        this.sendAllErrors();
    }
    setMessages(messages) {
        const all = this.convert(messages);
        this.messages = this.messages.filter(({ _time }) => Date.now() - _time < this.maxMessageTime);
        this.messages.push(...all.filter(({ severity }) => severity === 'repl'));
        this.upiRepl.setMessages(this.messages);
    }
    convert(xs) {
        const _time = Date.now();
        return xs.map((x) => (Object.assign(Object.assign({}, x), { _time })));
    }
    sendAllErrors() {
        let errors = [];
        for (const [source, errorArr] of this.errors.entries()) {
            if (!atom.config.get('ide-haskell-repl.checkOnSave') &&
                source.startsWith('bg:')) {
                continue;
            }
            errors = errors.filter((x) => !errorArr.some((y) => x._time <= y._time &&
                x.context === y.context &&
                compareMessage(x.message, y.message) &&
                comparePosition(x.position, y.position) &&
                x.severity === y.severity));
            errors.push(...errorArr);
        }
        this.upiErrors.setMessages(errors);
    }
    async shouldShowTooltip(editor, crange, _type) {
        if (!atom.config.get('ide-haskell-repl.showTypes')) {
            return undefined;
        }
        const path = editor.getPath();
        if (!path)
            return undefined;
        const buffer = editor.getBuffer();
        const { bg } = await this.getBgRepl(buffer);
        if (!bg)
            return undefined;
        return bg.showTypeAt(path, crange);
    }
    async didSaveBuffer(buffer) {
        if (!atom.config.get('ide-haskell-repl.checkOnSave') &&
            !atom.config.get('ide-haskell-repl.showTypes')) {
            return;
        }
        const { bg, isNew } = await this.getBgRepl(buffer);
        if (bg) {
            if (isNew)
                await bg.readyPromise;
            else
                await bg.ghciReload();
        }
    }
    async getBgRepl(buffer) {
        const path = buffer.getPath();
        if (!path)
            return { bg: undefined, isNew: false };
        const { cwd, cabal, comp } = await ide_haskell_repl_base_1.IdeHaskellReplBase.componentFromURI(path);
        const hash = `${cwd.getPath()}::${cabal && cabal.name}::${comp && comp[0]}`;
        let bgrec = this.bgEditorMap.get(hash);
        let isNew = false;
        if (!bgrec) {
            bgrec = this.createNewBgRepl(hash, path);
            isNew = true;
        }
        subscribeToBuffer(bgrec, buffer);
        return { bg: bgrec.bg, isNew };
    }
    createNewBgRepl(hash, path) {
        const bg = new ide_haskell_repl_bg_1.IdeHaskellReplBg(this, { uri: path });
        const bgrec = {
            bg,
            references: 0,
            buffers: new WeakSet(),
            disposables: new atom_1.CompositeDisposable(),
            dispose: () => {
                this.disposables.delete(bgrec);
                this.bgEditorMap.delete(hash);
                bgrec.bg.destroy();
                bgrec.disposables.dispose();
            },
        };
        this.disposables.add(bgrec);
        this.bgEditorMap.set(hash, bgrec);
        bgrec.disposables.add(bg.onDidDestroy(() => {
            bgrec.dispose();
        }));
        return bgrec;
    }
}
exports.UPIConsumer = UPIConsumer;
function subscribeToBuffer(rec, buffer) {
    if (rec.buffers.has(buffer))
        return;
    rec.references++;
    rec.buffers.add(buffer);
    rec.disposables.add(buffer.onDidDestroy(() => {
        rec.buffers.delete(buffer);
        rec.references--;
        if (rec.references === 0) {
            rec.dispose();
        }
    }));
}
function comparePosition(x, y) {
    if (x && y) {
        return atom_1.Point.fromObject(x).isEqual(y);
    }
    else {
        return x === y;
    }
}
function compareMessage(x, y) {
    if (typeof x === 'string' && typeof y === 'string') {
        return x === y;
    }
    else if (isTextMessage(x) && isTextMessage(y)) {
        return x.text === y.text;
    }
    else if (isHTMLMessage(x) && isHTMLMessage(y)) {
        return x.html === y.html;
    }
    return false;
}
function isTextMessage(x) {
    return x.text !== undefined;
}
function isHTMLMessage(x) {
    return x.text !== undefined;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBpQ29uc3VtZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXBpQ29uc3VtZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFPQSwrQkFPYTtBQUNiLG1FQUE0RDtBQUM1RCwrREFBd0Q7QUFjeEQsTUFBYSxXQUFXO0lBU3RCLFlBQVksUUFBMEI7UUFOOUIsYUFBUSxHQUFpQixFQUFFLENBQUE7UUFDM0IsV0FBTSxHQUE4QixJQUFJLEdBQUcsRUFBRSxDQUFBO1FBQzdDLGdCQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBQ3ZDLG1CQUFjLEdBQUcsS0FBSyxDQUFBO1FBQ3RCLGdCQUFXLEdBQUcsSUFBSSxHQUFHLEVBQWlCLENBQUE7UUFHNUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQ2xCLENBQUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxRQUFRLENBQUM7WUFDdkIsSUFBSSxFQUFFLGtCQUFrQjtZQUN4QixZQUFZLEVBQUU7Z0JBQ1osSUFBSSxFQUFFO29CQUNKLFNBQVMsRUFBRSxLQUFLO29CQUNoQixVQUFVLEVBQUUsSUFBSTtpQkFDakI7YUFDRjtZQUNELE9BQU8sRUFBRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztZQUMxQyxNQUFNLEVBQUU7Z0JBQ04sZUFBZSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQzthQUMvQztTQUNGLENBQUMsQ0FBQyxFQUNILENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUM7WUFDekIsSUFBSSxFQUFFLDBCQUEwQjtTQUNqQyxDQUFDLENBQUMsQ0FDSixDQUFBO0lBQ0gsQ0FBQztJQUVNLE9BQU87UUFDWixJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFBO0lBQzVCLENBQUM7SUFFTSxLQUFLLENBQUMsVUFBVTtRQU1yQixNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxP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QUNWLE9BQU8sWUFBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUE7S0FDdEM7U0FBTTtRQUNMLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQTtLQUNmO0FBQ0gsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUNyQixDQUF3QixFQUN4QixDQUF3QjtJQUV4QixJQUFJLE9BQU8sQ0FBQyxLQUFLLFFBQVEsSUFBSSxPQUFPLENBQUMsS0FBSyxRQUFRLEVBQUU7UUFDbEQsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFBO0tBQ2Y7U0FBTSxJQUFJLGFBQWEsQ0FBQyxDQUFDLENBQUMsSUFBSSxhQUFhLENBQUMsQ0FBQyxDQUFDLEVBQUU7UUFDL0MsT0FBTyxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUE7S0FDekI7U0FBTSxJQUFJLGFBQWEsQ0FBQyxDQUFDLENBQUMsSUFBSSxhQUFhLENBQUMsQ0FBQyxDQUFDLEVBQUU7UUFDL0MsT0FBTyxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUE7S0FDekI7SUFDRCxPQUFPLEtBQUssQ0FBQTtBQUNkLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FBQyxDQUF3QjtJQUM3QyxPQUFRLENBQVMsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFBO0FBQ3RDLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FBQyxDQUF3QjtJQUM3QyxPQUFRLENBQVMsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFBO0FBQ3RDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJVVBJSW5zdGFuY2UsXG4gIElSZXN1bHRJdGVtLFxuICBJVVBJUmVnaXN0cmF0aW9uLFxuICBJTWVzc2FnZVRleHQsXG4gIElNZXNzYWdlSFRNTCxcbn0gZnJvbSAnYXRvbS1oYXNrZWxsLXVwaSdcbmltcG9ydCB7XG4gIENvbXBvc2l0ZURpc3Bvc2FibGUsXG4gIFRleHRFZGl0b3IsXG4gIFJhbmdlLFxuICBUZXh0QnVmZmVyLFxuICBQb2ludCxcbiAgUG9pbnRDb21wYXRpYmxlLFxufSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgSWRlSGFza2VsbFJlcGxCYXNlIH0gZnJvbSAnLi9pZGUtaGFza2VsbC1yZXBsLWJhc2UnXG5pbXBvcnQgeyBJZGVIYXNrZWxsUmVwbEJnIH0gZnJvbSAnLi9pZGUtaGFza2VsbC1yZXBsLWJnJ1xuXG5leHBvcnQgaW50ZXJmYWNlIElFcnJvckl0ZW0gZXh0ZW5kcyBJUmVzdWx0SXRlbSB7XG4gIF90aW1lOiBudW1iZXJcbn1cblxuZXhwb3J0IGludGVyZmFjZSBCZ1JlYyB7XG4gIHJlZmVyZW5jZXM6IG51bWJlclxuICBiZzogSWRlSGFza2VsbFJlcGxCZ1xuICBidWZmZXJzOiBXZWFrU2V0PFRleHRCdWZmZXI+XG4gIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlXG4gIGRpc3Bvc2UoKTogdm9pZFxufVxuXG5leHBvcnQgY2xhc3MgVVBJQ29uc3VtZXIge1xuICBwcml2YXRlIHVwaVJlcGw6IElVUElJbnN0YW5jZVxuICBwcml2YXRlIHVwaUVycm9yczogSVVQSUluc3RhbmNlXG4gIHByaXZhdGUgbWVzc2FnZXM6IElFcnJvckl0ZW1bXSA9IFtdXG4gIHByaXZhdGUgZXJyb3JzOiBNYXA8c3RyaW5nLCBJRXJyb3JJdGVtW10+ID0gbmV3IE1hcCgpXG4gIHByaXZhdGUgZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIHByaXZhdGUgbWF4TWVzc2FnZVRpbWUgPSAxMDAwMFxuICBwcml2YXRlIGJnRWRpdG9yTWFwID0gbmV3IE1hcDxzdHJpbmcsIEJnUmVjPigpXG5cbiAgY29uc3RydWN0b3IocmVnaXN0ZXI6IElVUElSZWdpc3RyYXRpb24pIHtcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgICh0aGlzLnVwaVJlcGwgPSByZWdpc3Rlcih7XG4gICAgICAgIG5hbWU6ICdpZGUtaGFza2VsbC1yZXBsJyxcbiAgICAgICAgbWVzc2FnZVR5cGVzOiB7XG4gICAgICAgICAgcmVwbDoge1xuICAgICAgICAgICAgdXJpRmlsdGVyOiBmYWxzZSxcbiAgICAgICAgICAgIGF1dG9TY3JvbGw6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgdG9vbHRpcDogdGhpcy5zaG91bGRTaG93VG9vbHRpcC5iaW5kKHRoaXMpLFxuICAgICAgICBldmVudHM6IHtcbiAgICAgICAgICBvbkRpZFNhdmVCdWZmZXI6IHRoaXMuZGlkU2F2ZUJ1ZmZlci5iaW5kKHRoaXMpLFxuICAgICAgICB9LFxuICAgICAgfSkpLFxuICAgICAgKHRoaXMudXBpRXJyb3JzID0gcmVnaXN0ZXIoe1xuICAgICAgICBuYW1lOiAnaWRlLWhhc2tlbGwtcmVwbDo6ZXJyb3JzJyxcbiAgICAgIH0pKSxcbiAgICApXG4gIH1cblxuICBwdWJsaWMgZGlzcG9zZSgpIHtcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldEJ1aWxkZXIoKTogUHJvbWlzZTxcbiAgICB8IHtcbiAgICAgICAgbmFtZTogJ2NhYmFsLXYxJyB8ICdzdGFjaycgfCAnY2FiYWwtdjInIHwgJ25vbmUnXG4gICAgICB9XG4gICAgfCB1bmRlZmluZWRcbiAgPiB7XG4gICAgY29uc3QgYnVpbGRlciA9IGF3YWl0IHRoaXMudXBpUmVwbC5nZXRPdGhlcnNDb25maWdQYXJhbTx7XG4gICAgICBuYW1lOiAnY2FiYWwtdjEnIHwgJ3N0YWNrJyB8ICdjYWJhbC12MicgfCAnbm9uZSdcbiAgICB9PignaWRlLWhhc2tlbGwtY2FiYWwnLCAnYnVpbGRlcicpXG4gICAgLy8gYmFja3dhcmRzIGNvbXBhdGliaWxpdHlcbiAgICBzd2l0Y2ggKGJ1aWxkZXIgJiYgKGJ1aWxkZXIubmFtZSBhcyBzdHJpbmcpKSB7XG4gICAgICBjYXNlICdjYWJhbCc6XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgICAgIGJ1aWxkZXIhLm5hbWUgPSAnY2FiYWwtdjEnIGFzIGNvbnN0XG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlICdjYWJhbC1uaXgnOlxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLW5vbi1udWxsLWFzc2VydGlvblxuICAgICAgICBidWlsZGVyIS5uYW1lID0gJ2NhYmFsLXYyJyBhcyBjb25zdFxuICAgICAgICBicmVha1xuICAgIH1cbiAgICByZXR1cm4gYnVpbGRlclxuICB9XG5cbiAgcHVibGljIHNldEVycm9ycyhzb3VyY2U6IHN0cmluZywgZXJyb3JzOiBJUmVzdWx0SXRlbVtdKSB7XG4gICAgdGhpcy5lcnJvcnMuc2V0KHNvdXJjZSwgdGhpcy5jb252ZXJ0KGVycm9ycykpXG4gICAgdGhpcy5zZW5kQWxsRXJyb3JzKClcbiAgfVxuXG4gIHB1YmxpYyBzZXRNZXNzYWdlcyhtZXNzYWdlczogSVJlc3VsdEl0ZW1bXSkge1xuICAgIGNvbnN0IGFsbCA9IHRoaXMuY29udmVydChtZXNzYWdlcylcbiAgICB0aGlzLm1lc3NhZ2VzID0gdGhpcy5tZXNzYWdlcy5maWx0ZXIoXG4gICAgICAoeyBfdGltZSB9KSA9PiBEYXRlLm5vdygpIC0gX3RpbWUgPCB0aGlzLm1heE1lc3NhZ2VUaW1lLFxuICAgIClcbiAgICB0aGlzLm1lc3NhZ2VzLnB1c2goLi4uYWxsLmZpbHRlcigoeyBzZXZlcml0eSB9KSA9PiBzZXZlcml0eSA9PT0gJ3JlcGwnKSlcbiAgICB0aGlzLnVwaVJlcGwuc2V0TWVzc2FnZXModGhpcy5tZXNzYWdlcylcbiAgfVxuXG4gIHByaXZhdGUgY29udmVydCh4czogSVJlc3VsdEl0ZW1bXSk6IElFcnJvckl0ZW1bXSB7XG4gICAgY29uc3QgX3RpbWUgPSBEYXRlLm5vdygpXG4gICAgcmV0dXJuIHhzLm1hcCgoeCkgPT4gKHsgLi4ueCwgX3RpbWUgfSkpXG4gIH1cblxuICBwcml2YXRlIHNlbmRBbGxFcnJvcnMoKSB7XG4gICAgbGV0IGVycm9yczogSUVycm9ySXRlbVtdID0gW11cbiAgICBmb3IgKGNvbnN0IFtzb3VyY2UsIGVycm9yQXJyXSBvZiB0aGlzLmVycm9ycy5lbnRyaWVzKCkpIHtcbiAgICAgIGlmIChcbiAgICAgICAgIWF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwtcmVwbC5jaGVja09uU2F2ZScpICYmXG4gICAgICAgIHNvdXJjZS5zdGFydHNXaXRoKCdiZzonKVxuICAgICAgKSB7XG4gICAgICAgIGNvbnRpbnVlXG4gICAgICB9XG4gICAgICBlcnJvcnMgPSBlcnJvcnMuZmlsdGVyKFxuICAgICAgICAoeCkgPT5cbiAgICAgICAgICAhZXJyb3JBcnIuc29tZShcbiAgICAgICAgICAgICh5KSA9PlxuICAgICAgICAgICAgICB4Ll90aW1lIDw9IHkuX3RpbWUgJiZcbiAgICAgICAgICAgICAgeC5jb250ZXh0ID09PSB5LmNvbnRleHQgJiZcbiAgICAgICAgICAgICAgY29tcGFyZU1lc3NhZ2UoeC5tZXNzYWdlLCB5Lm1lc3NhZ2UpICYmXG4gICAgICAgICAgICAgIGNvbXBhcmVQb3NpdGlvbih4LnBvc2l0aW9uLCB5LnBvc2l0aW9uKSAmJlxuICAgICAgICAgICAgICB4LnNldmVyaXR5ID09PSB5LnNldmVyaXR5LFxuICAgICAgICAgICksXG4gICAgICApXG4gICAgICBlcnJvcnMucHVzaCguLi5lcnJvckFycilcbiAgICB9XG4gICAgdGhpcy51cGlFcnJvcnMuc2V0TWVzc2FnZXMoZXJyb3JzKVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzaG91bGRTaG93VG9vbHRpcChcbiAgICBlZGl0b3I6IFRleHRFZGl0b3IsXG4gICAgY3JhbmdlOiBSYW5nZSxcbiAgICBfdHlwZTogc3RyaW5nLFxuICApIHtcbiAgICBpZiAoIWF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwtcmVwbC5zaG93VHlwZXMnKSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgIH1cbiAgICBjb25zdCBwYXRoID0gZWRpdG9yLmdldFBhdGgoKVxuICAgIGlmICghcGF0aCkgcmV0dXJuIHVuZGVmaW5lZFxuICAgIGNvbnN0IGJ1ZmZlciA9IGVkaXRvci5nZXRCdWZmZXIoKVxuICAgIGNvbnN0IHsgYmcgfSA9IGF3YWl0IHRoaXMuZ2V0QmdSZXBsKGJ1ZmZlcilcbiAgICBpZiAoIWJnKSByZXR1cm4gdW5kZWZpbmVkXG4gICAgcmV0dXJuIGJnLnNob3dUeXBlQXQocGF0aCwgY3JhbmdlKVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBkaWRTYXZlQnVmZmVyKGJ1ZmZlcjogVGV4dEJ1ZmZlcikge1xuICAgIGlmIChcbiAgICAgICFhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLXJlcGwuY2hlY2tPblNhdmUnKSAmJlxuICAgICAgIWF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwtcmVwbC5zaG93VHlwZXMnKVxuICAgICkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIGNvbnN0IHsgYmcsIGlzTmV3IH0gPSBhd2FpdCB0aGlzLmdldEJnUmVwbChidWZmZXIpXG4gICAgaWYgKGJnKSB7XG4gICAgICAvLyBubyBuZWVkIHRvIHJlbG9hZCBuZXdseSBjcmVhdGVkIGluc3RhbmNlIHNpbmNlIGl0IHJlbG9hZHMgb24gc3RhcnRcbiAgICAgIGlmIChpc05ldykgYXdhaXQgYmcucmVhZHlQcm9taXNlXG4gICAgICBlbHNlIGF3YWl0IGJnLmdoY2lSZWxvYWQoKVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0QmdSZXBsKGJ1ZmZlcjogVGV4dEJ1ZmZlcikge1xuICAgIGNvbnN0IHBhdGggPSBidWZmZXIuZ2V0UGF0aCgpXG4gICAgaWYgKCFwYXRoKSByZXR1cm4geyBiZzogdW5kZWZpbmVkLCBpc05ldzogZmFsc2UgfVxuICAgIGNvbnN0IHsgY3dkLCBjYWJhbCwgY29tcCB9ID0gYXdhaXQgSWRlSGFza2VsbFJlcGxCYXNlLmNvbXBvbmVudEZyb21VUkkocGF0aClcbiAgICBjb25zdCBoYXNoID0gYCR7Y3dkLmdldFBhdGgoKX06OiR7Y2FiYWwgJiYgY2FiYWwubmFtZX06OiR7Y29tcCAmJiBjb21wWzBdfWBcbiAgICBsZXQgYmdyZWMgPSB0aGlzLmJnRWRpdG9yTWFwLmdldChoYXNoKVxuICAgIGxldCBpc05ldyA9IGZhbHNlXG4gICAgaWYgKCFiZ3JlYykge1xuICAgICAgYmdyZWMgPSB0aGlzLmNyZWF0ZU5ld0JnUmVwbChoYXNoLCBwYXRoKVxuICAgICAgaXNOZXcgPSB0cnVlXG4gICAgfVxuICAgIHN1YnNjcmliZVRvQnVmZmVyKGJncmVjLCBidWZmZXIpXG4gICAgcmV0dXJuIHsgYmc6IGJncmVjLmJnLCBpc05ldyB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZU5ld0JnUmVwbChoYXNoOiBzdHJpbmcsIHBhdGg6IHN0cmluZykge1xuICAgIGNvbnN0IGJnID0gbmV3IElkZUhhc2tlbGxSZXBsQmcodGhpcywgeyB1cmk6IHBhdGggfSlcbiAgICBjb25zdCBiZ3JlYzogQmdSZWMgPSB7XG4gICAgICBiZyxcbiAgICAgIHJlZmVyZW5jZXM6IDAsXG4gICAgICBidWZmZXJzOiBuZXcgV2Vha1NldCgpLFxuICAgICAgZGlzcG9zYWJsZXM6IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCksXG4gICAgICBkaXNwb3NlOiAoKSA9PiB7XG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZXMuZGVsZXRlKGJncmVjKVxuICAgICAgICB0aGlzLmJnRWRpdG9yTWFwLmRlbGV0ZShoYXNoKVxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgICAgYmdyZWMuYmcuZGVzdHJveSgpXG4gICAgICAgIGJncmVjLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICAgICAgfSxcbiAgICB9XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoYmdyZWMpXG4gICAgdGhpcy5iZ0VkaXRvck1hcC5zZXQoaGFzaCwgYmdyZWMpXG4gICAgYmdyZWMuZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgYmcub25EaWREZXN0cm95KCgpID0+IHtcbiAgICAgICAgYmdyZWMuZGlzcG9zZSgpXG4gICAgICB9KSxcbiAgICApXG4gICAgcmV0dXJuIGJncmVjXG4gIH1cbn1cblxuZnVuY3Rpb24gc3Vic2NyaWJlVG9CdWZmZXIocmVjOiBCZ1JlYywgYnVmZmVyOiBUZXh0QnVmZmVyKSB7XG4gIGlmIChyZWMuYnVmZmVycy5oYXMoYnVmZmVyKSkgcmV0dXJuXG4gIHJlYy5yZWZlcmVuY2VzKytcbiAgcmVjLmJ1ZmZlcnMuYWRkKGJ1ZmZlcilcbiAgcmVjLmRpc3Bvc2FibGVzLmFkZChcbiAgICBidWZmZXIub25EaWREZXN0cm95KCgpID0+IHtcbiAgICAgIHJlYy5idWZmZXJzLmRlbGV0ZShidWZmZXIpXG4gICAgICByZWMucmVmZXJlbmNlcy0tXG4gICAgICBpZiAocmVjLnJlZmVyZW5jZXMgPT09IDApIHtcbiAgICAgICAgcmVjLmRpc3Bvc2UoKVxuICAgICAgfVxuICAgIH0pLFxuICApXG59XG5cbmZ1bmN0aW9uIGNvbXBhcmVQb3NpdGlvbih4PzogUG9pbnRDb21wYXRpYmxlLCB5PzogUG9pbnRDb21wYXRpYmxlKTogYm9vbGVhbiB7XG4gIGlmICh4ICYmIHkpIHtcbiAgICByZXR1cm4gUG9pbnQuZnJvbU9iamVjdCh4KS5pc0VxdWFsKHkpXG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHggPT09IHlcbiAgfVxufVxuXG5mdW5jdGlvbiBjb21wYXJlTWVzc2FnZShcbiAgeDogSUVycm9ySXRlbVsnbWVzc2FnZSddLFxuICB5OiBJRXJyb3JJdGVtWydtZXNzYWdlJ10sXG4pOiBib29sZWFuIHtcbiAgaWYgKHR5cGVvZiB4ID09PSAnc3RyaW5nJyAmJiB0eXBlb2YgeSA9PT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4geCA9PT0geVxuICB9IGVsc2UgaWYgKGlzVGV4dE1lc3NhZ2UoeCkgJiYgaXNUZXh0TWVzc2FnZSh5KSkge1xuICAgIHJldHVybiB4LnRleHQgPT09IHkudGV4dFxuICB9IGVsc2UgaWYgKGlzSFRNTE1lc3NhZ2UoeCkgJiYgaXNIVE1MTWVzc2FnZSh5KSkge1xuICAgIHJldHVybiB4Lmh0bWwgPT09IHkuaHRtbFxuICB9XG4gIHJldHVybiBmYWxzZVxufVxuXG5mdW5jdGlvbiBpc1RleHRNZXNzYWdlKHg6IElFcnJvckl0ZW1bJ21lc3NhZ2UnXSk6IHggaXMgSU1lc3NhZ2VUZXh0IHtcbiAgcmV0dXJuICh4IGFzIGFueSkudGV4dCAhPT0gdW5kZWZpbmVkXG59XG5cbmZ1bmN0aW9uIGlzSFRNTE1lc3NhZ2UoeDogSUVycm9ySXRlbVsnbWVzc2FnZSddKTogeCBpcyBJTWVzc2FnZUhUTUwge1xuICByZXR1cm4gKHggYXMgYW55KS50ZXh0ICE9PSB1bmRlZmluZWRcbn1cbiJdfQ==