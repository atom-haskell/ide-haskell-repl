"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const atom_1 = require("atom");
const ide_haskell_repl_view_1 = require("./views/ide-haskell-repl-view");
const upiConsumer_1 = require("./upiConsumer");
const util_1 = require("./util");
const crypto_1 = require("crypto");
tslib_1.__exportStar(require("./config"), exports);
let disposables;
const editorMap = new WeakMap();
let resolveUPIPromise;
let upiPromise;
let resolveWatchEditorPromise;
const watchEditorPromise = new Promise((resolve) => {
    resolveWatchEditorPromise = resolve;
});
function activate() {
    disposables = new atom_1.CompositeDisposable();
    switch (atom.config.get('ide-haskell-repl').defaultRepl) {
        case 'cabal':
            atom.config.set('ide-haskell-repl.defaultRepl', 'cabal-v1');
            break;
        case 'cabal-nix':
        case 'cabal-new':
            atom.config.set('ide-haskell-repl.defaultRepl', 'cabal-v2');
            break;
    }
    initUpiPromise();
    disposables.add(atom.workspace.addOpener((uriToOpen) => {
        const m = uriToOpen.match(/^ide-haskell:\/\/repl\/(.*)$/);
        if (m && m[1] !== undefined) {
            return createReplView({ uri: m[1], focus: true });
        }
        return undefined;
    }));
    disposables.add(atom.commands.add('atom-text-editor', 'ide-haskell-repl:toggle', async ({ currentTarget }) => {
        util_1.handlePromise(open(currentTarget.getModel()));
    }));
    if (process.platform === 'win32') {
        disposables.add(atom.commands.add('atom-workspace', 'ide-haskell-repl:setup-ghci-wrapper', async () => {
            const downloadUrl = 'https://github.com/atom-haskell/win-ghci-wrapper/releases/download/v0.0.2/ghci-wrapper.exe';
            const expectedDigest = '4663295d71a5057dee41945a52d39ed61fcd8830';
            try {
                atom.notifications.addInfo('GHCi Wrapper setup started...');
                const result = await window.fetch(downloadUrl, {
                    redirect: 'follow',
                });
                if (!result.ok) {
                    atom.notifications.addError('Getting ghci-wrapper.exe failed', {
                        detail: result.statusText,
                        dismissable: true,
                    });
                    return;
                }
                const configDir = new atom_1.Directory(atom.getConfigDirPath());
                const subdir = configDir.getSubdirectory('ide-haskell-repl');
                if (!(await subdir.exists()))
                    subdir.create();
                const file = subdir.getFile('ghci-wrapper.exe');
                const stream = file.createWriteStream();
                const buf = Buffer.from(await result.arrayBuffer());
                const hash = crypto_1.createHash('sha1');
                hash.update(buf);
                const digest = hash.digest('hex');
                if (digest !== expectedDigest) {
                    atom.notifications.addError('Got ghci-wrapper.exe, but hash check failed!', {
                        detail: `Expected ${expectedDigest} but got ${digest}`,
                        dismissable: true,
                    });
                    return;
                }
                stream.write(buf);
                stream.close();
                atom.config.set('ide-haskell-repl.ghciWrapperPath', file.getPath());
                atom.notifications.addSuccess('GHCi Wrapper setup finished!');
            }
            catch (e) {
                atom.notifications.addFatalError('GHCi wrapper setup failed', {
                    stack: e.stack,
                    detail: e.message,
                });
            }
        }));
    }
    const commandFunction = (func) => ({ currentTarget, }) => {
        const view = editorMap.get(currentTarget.getModel());
        if (view) {
            ;
            view[func]();
        }
    };
    disposables.add(atom.commands.add('atom-text-editor.ide-haskell-repl', {
        'ide-haskell-repl:exec-command': commandFunction('execCommand'),
        'ide-haskell-repl:history-back': commandFunction('historyBack'),
        'ide-haskell-repl:history-forward': commandFunction('historyForward'),
        'ide-haskell-repl:ghci-reload': commandFunction('ghciReload'),
        'ide-haskell-repl:reload-repeat': commandFunction('ghciReloadRepeat'),
        'ide-haskell-repl:toggle-auto-reload-repeat': commandFunction('toggleAutoReloadRepeat'),
        'ide-haskell-repl:ghci-interrupt': commandFunction('interrupt'),
        'ide-haskell-repl:clear-output': commandFunction('clear'),
    }));
    const externalCommandFunction = (func) => ({ currentTarget, }) => {
        open(currentTarget.getModel(), false).then((model) => model[func]());
    };
    disposables.add(atom.commands.add('atom-text-editor:not(.ide-haskell-repl)', {
        'ide-haskell-repl:copy-selection-to-repl-input': ({ currentTarget }) => {
            const ed = currentTarget.getModel();
            const cmd = ed.getLastSelection().getText();
            open(ed).then((model) => model.copyText(cmd));
        },
        'ide-haskell-repl:run-selection-in-repl': ({ currentTarget }) => {
            const ed = currentTarget.getModel();
            const cmd = ed.getLastSelection().getText();
            open(ed, false).then(async (model) => model.runCommand(cmd));
        },
        'ide-haskell-repl:ghci-reload': externalCommandFunction('ghciReload'),
        'ide-haskell-repl:reload-repeat': externalCommandFunction('ghciReloadRepeat'),
        'ide-haskell-repl:toggle-auto-reload-repeat': externalCommandFunction('toggleAutoReloadRepeat'),
    }));
    disposables.add(atom.menu.add([
        {
            label: 'Haskell IDE',
            submenu: [
                {
                    label: 'Open REPL',
                    command: 'ide-haskell-repl:toggle',
                },
            ],
        },
    ]));
    setTimeout(() => {
        resolveUPIPromise();
    }, 5000);
}
exports.activate = activate;
function createReplView(state) {
    const upiPromise = initUpiPromise();
    const view = new ide_haskell_repl_view_1.IdeHaskellReplView({ upiPromise, state, watchEditorPromise });
    editorMap.set(view.editor, view);
    return view;
}
exports.createReplView = createReplView;
async function open(editor, activate = true) {
    const grammar = editor && editor.getGrammar();
    const scope = grammar && grammar.scopeName;
    let uri;
    if (scope && scope.endsWith('haskell')) {
        uri = editor.getPath();
    }
    else {
        uri = '';
    }
    return atom.workspace.open(`ide-haskell://repl/${uri}`, {
        split: 'right',
        searchAllPanes: true,
        activatePane: activate,
    });
}
function deactivate() {
    upiPromise = undefined;
    disposables.dispose();
}
exports.deactivate = deactivate;
function consumeUPI(register) {
    const consumer = new upiConsumer_1.UPIConsumer(register);
    disposables.add(consumer);
    resolveUPIPromise(consumer);
    return consumer;
}
exports.consumeUPI = consumeUPI;
function autocompleteProvider_3_0_0() {
    return {
        scopeSelector: '.source.haskell',
        disableForScopeSelector: '.source.haskell .comment',
        inclusionPriority: 0,
        labels: ['ide-haskell-repl'],
        getSuggestions: async ({ editor, prefix, }) => {
            const view = editorMap.get(editor);
            if (!view) {
                return [];
            }
            return view.getCompletions(prefix);
        },
    };
}
exports.autocompleteProvider_3_0_0 = autocompleteProvider_3_0_0;
function consumeWatchEditor(watchEditor) {
    resolveWatchEditorPromise(watchEditor);
}
exports.consumeWatchEditor = consumeWatchEditor;
async function initUpiPromise() {
    if (!upiPromise) {
        upiPromise = new Promise((resolve) => {
            resolveUPIPromise = resolve;
        });
    }
    return upiPromise;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRlLWhhc2tlbGwtcmVwbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9pZGUtaGFza2VsbC1yZXBsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLCtCQU9hO0FBQ2IseUVBQThFO0FBRTlFLCtDQUEyQztBQUMzQyxpQ0FBc0M7QUFDdEMsbUNBQW1DO0FBRW5DLG1EQUF3QjtBQUV4QixJQUFJLFdBQWdDLENBQUE7QUFDcEMsTUFBTSxTQUFTLEdBQTRDLElBQUksT0FBTyxFQUFFLENBQUE7QUFDeEUsSUFBSSxpQkFBOEMsQ0FBQTtBQUNsRCxJQUFJLFVBQXdELENBQUE7QUFDNUQsSUFBSSx5QkFBcUQsQ0FBQTtBQUN6RCxNQUFNLGtCQUFrQixHQUFHLElBQUksT0FBTyxDQUFlLENBQUMsT0FBTyxFQUFFLEVBQUU7SUFDL0QseUJBQXlCLEdBQUcsT0FBTyxDQUFBO0FBQ3JDLENBQUMsQ0FBQyxDQUFBO0FBRUYsU0FBZ0IsUUFBUTtJQUN0QixXQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO0lBR3ZDLFFBQVEsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxXQUFxQixFQUFFO1FBQ2pFLEtBQUssT0FBTztZQUNWLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLDhCQUE4QixFQUFFLFVBQVUsQ0FBQyxDQUFBO1lBQzNELE1BQUs7UUFDUCxLQUFLLFdBQVcsQ0FBQztRQUNqQixLQUFLLFdBQVc7WUFDZCxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyw4QkFBOEIsRUFBRSxVQUFVLENBQUMsQ0FBQTtZQUMzRCxNQUFLO0tBQ1I7SUFFRCxjQUFjLEVBQUUsQ0FBQTtJQUVoQixXQUFXLENBQUMsR0FBRyxDQUNiLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUMsU0FBaUIsRUFBRSxFQUFFO1FBQzdDLE1BQU0sQ0FBQyxHQUFHLFNBQVMsQ0FBQyxLQUFLLENB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QWdCLGtCQUFrQixDQUFDLFdBQXlCO0lBQzFELHlCQUF5QixDQUFDLFdBQVcsQ0FBQyxDQUFBO0FBQ3hDLENBQUM7QUFGRCxnREFFQztBQUVELEtBQUssVUFBVSxjQUFjO0lBQzNCLElBQUksQ0FBQyxVQUFVLEVBQUU7UUFDZixVQUFVLEdBQUcsSUFBSSxPQUFPLENBQTBCLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDNUQsaUJBQWlCLEdBQUcsT0FBTyxDQUFBO1FBQzdCLENBQUMsQ0FBQyxDQUFBO0tBQ0g7SUFDRCxPQUFPLFVBQVUsQ0FBQTtBQUNuQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9zaXRlRGlzcG9zYWJsZSxcbiAgVFdhdGNoRWRpdG9yLFxuICBDb21tYW5kRXZlbnQsXG4gIFRleHRFZGl0b3IsXG4gIFRleHRFZGl0b3JFbGVtZW50LFxuICBEaXJlY3RvcnksXG59IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBJZGVIYXNrZWxsUmVwbFZpZXcsIElWaWV3U3RhdGUgfSBmcm9tICcuL3ZpZXdzL2lkZS1oYXNrZWxsLXJlcGwtdmlldydcbmltcG9ydCAqIGFzIFVQSSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xuaW1wb3J0IHsgVVBJQ29uc3VtZXIgfSBmcm9tICcuL3VwaUNvbnN1bWVyJ1xuaW1wb3J0IHsgaGFuZGxlUHJvbWlzZSB9IGZyb20gJy4vdXRpbCdcbmltcG9ydCB7IGNyZWF0ZUhhc2ggfSBmcm9tICdjcnlwdG8nXG5cbmV4cG9ydCAqIGZyb20gJy4vY29uZmlnJ1xuXG5sZXQgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGVcbmNvbnN0IGVkaXRvck1hcDogV2Vha01hcDxUZXh0RWRpdG9yLCBJZGVIYXNrZWxsUmVwbFZpZXc+ID0gbmV3IFdlYWtNYXAoKVxubGV0IHJlc29sdmVVUElQcm9taXNlOiAodXBpPzogVVBJQ29uc3VtZXIpID0+IHZvaWRcbmxldCB1cGlQcm9taXNlOiBQcm9taXNlPFVQSUNvbnN1bWVyIHwgdW5kZWZpbmVkPiB8IHVuZGVmaW5lZFxubGV0IHJlc29sdmVXYXRjaEVkaXRvclByb21pc2U6ICh3ZTogVFdhdGNoRWRpdG9yKSA9PiB2b2lkXG5jb25zdCB3YXRjaEVkaXRvclByb21pc2UgPSBuZXcgUHJvbWlzZTxUV2F0Y2hFZGl0b3I+KChyZXNvbHZlKSA9PiB7XG4gIHJlc29sdmVXYXRjaEVkaXRvclByb21pc2UgPSByZXNvbHZlXG59KVxuXG5leHBvcnQgZnVuY3Rpb24gYWN0aXZhdGUoKSB7XG4gIGRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuXG4gIC8vIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5XG4gIHN3aXRjaCAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1yZXBsJykuZGVmYXVsdFJlcGwgYXMgc3RyaW5nKSB7XG4gICAgY2FzZSAnY2FiYWwnOlxuICAgICAgYXRvbS5jb25maWcuc2V0KCdpZGUtaGFza2VsbC1yZXBsLmRlZmF1bHRSZXBsJywgJ2NhYmFsLXYxJylcbiAgICAgIGJyZWFrXG4gICAgY2FzZSAnY2FiYWwtbml4JzpcbiAgICBjYXNlICdjYWJhbC1uZXcnOlxuICAgICAgYXRvbS5jb25maWcuc2V0KCdpZGUtaGFza2VsbC1yZXBsLmRlZmF1bHRSZXBsJywgJ2NhYmFsLXYyJylcbiAgICAgIGJyZWFrXG4gIH1cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gIGluaXRVcGlQcm9taXNlKClcblxuICBkaXNwb3NhYmxlcy5hZGQoXG4gICAgYXRvbS53b3Jrc3BhY2UuYWRkT3BlbmVyKCh1cmlUb09wZW46IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgbSA9IHVyaVRvT3Blbi5tYXRjaCgvXmlkZS1oYXNrZWxsOlxcL1xcL3JlcGxcXC8oLiopJC8pXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6c3RyaWN0LXR5cGUtcHJlZGljYXRlc1xuICAgICAgaWYgKG0gJiYgbVsxXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJldHVybiBjcmVhdGVSZXBsVmlldyh7IHVyaTogbVsxXSwgZm9jdXM6IHRydWUgfSlcbiAgICAgIH1cbiAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICB9KSxcbiAgKVxuXG4gIGRpc3Bvc2FibGVzLmFkZChcbiAgICBhdG9tLmNvbW1hbmRzLmFkZChcbiAgICAgICdhdG9tLXRleHQtZWRpdG9yJyxcbiAgICAgICdpZGUtaGFza2VsbC1yZXBsOnRvZ2dsZScsXG4gICAgICBhc3luYyAoeyBjdXJyZW50VGFyZ2V0IH0pID0+IHtcbiAgICAgICAgaGFuZGxlUHJvbWlzZShvcGVuKGN1cnJlbnRUYXJnZXQuZ2V0TW9kZWwoKSkpXG4gICAgICB9LFxuICAgICksXG4gIClcblxuICBpZiAocHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJykge1xuICAgIGRpc3Bvc2FibGVzLmFkZChcbiAgICAgIGF0b20uY29tbWFuZHMuYWRkKFxuICAgICAgICAnYXRvbS13b3Jrc3BhY2UnLFxuICAgICAgICAnaWRlLWhhc2tlbGwtcmVwbDpzZXR1cC1naGNpLXdyYXBwZXInLFxuICAgICAgICBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgY29uc3QgZG93bmxvYWRVcmwgPVxuICAgICAgICAgICAgJ2h0dHBzOi8vZ2l0aHViLmNvbS9hdG9tLWhhc2tlbGwvd2luLWdoY2ktd3JhcHBlci9yZWxlYXNlcy9kb3dubG9hZC92MC4wLjIvZ2hjaS13cmFwcGVyLmV4ZSdcbiAgICAgICAgICBjb25zdCBleHBlY3RlZERpZ2VzdCA9ICc0NjYzMjk1ZDcxYTUwNTdkZWU0MTk0NWE1MmQzOWVkNjFmY2Q4ODMwJ1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkSW5mbygnR0hDaSBXcmFwcGVyIHNldHVwIHN0YXJ0ZWQuLi4nKVxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgd2luZG93LmZldGNoKGRvd25sb2FkVXJsLCB7XG4gICAgICAgICAgICAgIHJlZGlyZWN0OiAnZm9sbG93JyxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBpZiAoIXJlc3VsdC5vaykge1xuICAgICAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoJ0dldHRpbmcgZ2hjaS13cmFwcGVyLmV4ZSBmYWlsZWQnLCB7XG4gICAgICAgICAgICAgICAgZGV0YWlsOiByZXN1bHQuc3RhdHVzVGV4dCxcbiAgICAgICAgICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBjb25maWdEaXIgPSBuZXcgRGlyZWN0b3J5KGF0b20uZ2V0Q29uZmlnRGlyUGF0aCgpKVxuICAgICAgICAgICAgY29uc3Qgc3ViZGlyID0gY29uZmlnRGlyLmdldFN1YmRpcmVjdG9yeSgnaWRlLWhhc2tlbGwtcmVwbCcpXG4gICAgICAgICAgICBpZiAoIShhd2FpdCBzdWJkaXIuZXhpc3RzKCkpKSBzdWJkaXIuY3JlYXRlKClcbiAgICAgICAgICAgIGNvbnN0IGZpbGUgPSBzdWJkaXIuZ2V0RmlsZSgnZ2hjaS13cmFwcGVyLmV4ZScpXG4gICAgICAgICAgICBjb25zdCBzdHJlYW0gPSBmaWxlLmNyZWF0ZVdyaXRlU3RyZWFtKClcbiAgICAgICAgICAgIGNvbnN0IGJ1ZiA9IEJ1ZmZlci5mcm9tKGF3YWl0IHJlc3VsdC5hcnJheUJ1ZmZlcigpKVxuICAgICAgICAgICAgY29uc3QgaGFzaCA9IGNyZWF0ZUhhc2goJ3NoYTEnKVxuICAgICAgICAgICAgaGFzaC51cGRhdGUoYnVmKVxuICAgICAgICAgICAgY29uc3QgZGlnZXN0ID0gaGFzaC5kaWdlc3QoJ2hleCcpXG4gICAgICAgICAgICBpZiAoZGlnZXN0ICE9PSBleHBlY3RlZERpZ2VzdCkge1xuICAgICAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoXG4gICAgICAgICAgICAgICAgJ0dvdCBnaGNpLXdyYXBwZXIuZXhlLCBidXQgaGFzaCBjaGVjayBmYWlsZWQhJyxcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICBkZXRhaWw6IGBFeHBlY3RlZCAke2V4cGVjdGVkRGlnZXN0fSBidXQgZ290ICR7ZGlnZXN0fWAsXG4gICAgICAgICAgICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3RyZWFtLndyaXRlKGJ1ZilcbiAgICAgICAgICAgIHN0cmVhbS5jbG9zZSgpXG4gICAgICAgICAgICBhdG9tLmNvbmZpZy5zZXQoJ2lkZS1oYXNrZWxsLXJlcGwuZ2hjaVdyYXBwZXJQYXRoJywgZmlsZS5nZXRQYXRoKCkpXG4gICAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkU3VjY2VzcygnR0hDaSBXcmFwcGVyIHNldHVwIGZpbmlzaGVkIScpXG4gICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEZhdGFsRXJyb3IoJ0dIQ2kgd3JhcHBlciBzZXR1cCBmYWlsZWQnLCB7XG4gICAgICAgICAgICAgIHN0YWNrOiBlLnN0YWNrLFxuICAgICAgICAgICAgICBkZXRhaWw6IGUubWVzc2FnZSxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgKSxcbiAgICApXG4gIH1cblxuICBjb25zdCBjb21tYW5kRnVuY3Rpb24gPSAoZnVuYzogc3RyaW5nKSA9PiAoe1xuICAgIGN1cnJlbnRUYXJnZXQsXG4gIH06IENvbW1hbmRFdmVudDxUZXh0RWRpdG9yRWxlbWVudD4pID0+IHtcbiAgICBjb25zdCB2aWV3ID0gZWRpdG9yTWFwLmdldChjdXJyZW50VGFyZ2V0LmdldE1vZGVsKCkpXG4gICAgaWYgKHZpZXcpIHtcbiAgICAgIDsodmlld1tmdW5jXSBhcyAoKSA9PiB2b2lkKSgpXG4gICAgfVxuICB9XG5cbiAgZGlzcG9zYWJsZXMuYWRkKFxuICAgIGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXRleHQtZWRpdG9yLmlkZS1oYXNrZWxsLXJlcGwnLCB7XG4gICAgICAnaWRlLWhhc2tlbGwtcmVwbDpleGVjLWNvbW1hbmQnOiBjb21tYW5kRnVuY3Rpb24oJ2V4ZWNDb21tYW5kJyksXG4gICAgICAnaWRlLWhhc2tlbGwtcmVwbDpoaXN0b3J5LWJhY2snOiBjb21tYW5kRnVuY3Rpb24oJ2hpc3RvcnlCYWNrJyksXG4gICAgICAnaWRlLWhhc2tlbGwtcmVwbDpoaXN0b3J5LWZvcndhcmQnOiBjb21tYW5kRnVuY3Rpb24oJ2hpc3RvcnlGb3J3YXJkJyksXG4gICAgICAnaWRlLWhhc2tlbGwtcmVwbDpnaGNpLXJlbG9hZCc6IGNvbW1hbmRGdW5jdGlvbignZ2hjaVJlbG9hZCcpLFxuICAgICAgJ2lkZS1oYXNrZWxsLXJlcGw6cmVsb2FkLXJlcGVhdCc6IGNvbW1hbmRGdW5jdGlvbignZ2hjaVJlbG9hZFJlcGVhdCcpLFxuICAgICAgJ2lkZS1oYXNrZWxsLXJlcGw6dG9nZ2xlLWF1dG8tcmVsb2FkLXJlcGVhdCc6IGNvbW1hbmRGdW5jdGlvbihcbiAgICAgICAgJ3RvZ2dsZUF1dG9SZWxvYWRSZXBlYXQnLFxuICAgICAgKSxcbiAgICAgICdpZGUtaGFza2VsbC1yZXBsOmdoY2ktaW50ZXJydXB0JzogY29tbWFuZEZ1bmN0aW9uKCdpbnRlcnJ1cHQnKSxcbiAgICAgICdpZGUtaGFza2VsbC1yZXBsOmNsZWFyLW91dHB1dCc6IGNvbW1hbmRGdW5jdGlvbignY2xlYXInKSxcbiAgICB9KSxcbiAgKVxuXG4gIGNvbnN0IGV4dGVybmFsQ29tbWFuZEZ1bmN0aW9uID0gKGZ1bmM6IHN0cmluZykgPT4gKHtcbiAgICBjdXJyZW50VGFyZ2V0LFxuICB9OiBDb21tYW5kRXZlbnQ8VGV4dEVkaXRvckVsZW1lbnQ+KSA9PiB7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgb3BlbihjdXJyZW50VGFyZ2V0LmdldE1vZGVsKCksIGZhbHNlKS50aGVuKChtb2RlbCkgPT5cbiAgICAgIChtb2RlbFtmdW5jXSBhcyAoKSA9PiB2b2lkKSgpLFxuICAgIClcbiAgfVxuXG4gIGRpc3Bvc2FibGVzLmFkZChcbiAgICBhdG9tLmNvbW1hbmRzLmFkZCgnYXRvbS10ZXh0LWVkaXRvcjpub3QoLmlkZS1oYXNrZWxsLXJlcGwpJywge1xuICAgICAgJ2lkZS1oYXNrZWxsLXJlcGw6Y29weS1zZWxlY3Rpb24tdG8tcmVwbC1pbnB1dCc6ICh7IGN1cnJlbnRUYXJnZXQgfSkgPT4ge1xuICAgICAgICBjb25zdCBlZCA9IGN1cnJlbnRUYXJnZXQuZ2V0TW9kZWwoKVxuICAgICAgICBjb25zdCBjbWQgPSBlZC5nZXRMYXN0U2VsZWN0aW9uKCkuZ2V0VGV4dCgpXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mbG9hdGluZy1wcm9taXNlc1xuICAgICAgICBvcGVuKGVkKS50aGVuKChtb2RlbCkgPT4gbW9kZWwuY29weVRleHQoY21kKSlcbiAgICAgIH0sXG4gICAgICAnaWRlLWhhc2tlbGwtcmVwbDpydW4tc2VsZWN0aW9uLWluLXJlcGwnOiAoeyBjdXJyZW50VGFyZ2V0IH0pID0+IHtcbiAgICAgICAgY29uc3QgZWQgPSBjdXJyZW50VGFyZ2V0LmdldE1vZGVsKClcbiAgICAgICAgY29uc3QgY21kID0gZWQuZ2V0TGFzdFNlbGVjdGlvbigpLmdldFRleHQoKVxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgICAgb3BlbihlZCwgZmFsc2UpLnRoZW4oYXN5bmMgKG1vZGVsKSA9PiBtb2RlbC5ydW5Db21tYW5kKGNtZCkpXG4gICAgICB9LFxuICAgICAgJ2lkZS1oYXNrZWxsLXJlcGw6Z2hjaS1yZWxvYWQnOiBleHRlcm5hbENvbW1hbmRGdW5jdGlvbignZ2hjaVJlbG9hZCcpLFxuICAgICAgJ2lkZS1oYXNrZWxsLXJlcGw6cmVsb2FkLXJlcGVhdCc6IGV4dGVybmFsQ29tbWFuZEZ1bmN0aW9uKFxuICAgICAgICAnZ2hjaVJlbG9hZFJlcGVhdCcsXG4gICAgICApLFxuICAgICAgJ2lkZS1oYXNrZWxsLXJlcGw6dG9nZ2xlLWF1dG8tcmVsb2FkLXJlcGVhdCc6IGV4dGVybmFsQ29tbWFuZEZ1bmN0aW9uKFxuICAgICAgICAndG9nZ2xlQXV0b1JlbG9hZFJlcGVhdCcsXG4gICAgICApLFxuICAgIH0pLFxuICApXG5cbiAgZGlzcG9zYWJsZXMuYWRkKFxuICAgIGF0b20ubWVudS5hZGQoW1xuICAgICAge1xuICAgICAgICBsYWJlbDogJ0hhc2tlbGwgSURFJyxcbiAgICAgICAgc3VibWVudTogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIGxhYmVsOiAnT3BlbiBSRVBMJyxcbiAgICAgICAgICAgIGNvbW1hbmQ6ICdpZGUtaGFza2VsbC1yZXBsOnRvZ2dsZScsXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgIH0sXG4gICAgXSksXG4gIClcblxuICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICByZXNvbHZlVVBJUHJvbWlzZSgpXG4gIH0sIDUwMDApXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVSZXBsVmlldyhzdGF0ZTogSVZpZXdTdGF0ZSkge1xuICBjb25zdCB1cGlQcm9taXNlID0gaW5pdFVwaVByb21pc2UoKVxuICBjb25zdCB2aWV3ID0gbmV3IElkZUhhc2tlbGxSZXBsVmlldyh7IHVwaVByb21pc2UsIHN0YXRlLCB3YXRjaEVkaXRvclByb21pc2UgfSlcbiAgZWRpdG9yTWFwLnNldCh2aWV3LmVkaXRvciwgdmlldylcbiAgcmV0dXJuIHZpZXdcbn1cblxuYXN5bmMgZnVuY3Rpb24gb3BlbihcbiAgZWRpdG9yOiBUZXh0RWRpdG9yLFxuICBhY3RpdmF0ZSA9IHRydWUsXG4pOiBQcm9taXNlPElkZUhhc2tlbGxSZXBsVmlldz4ge1xuICBjb25zdCBncmFtbWFyID0gZWRpdG9yICYmIGVkaXRvci5nZXRHcmFtbWFyKClcbiAgY29uc3Qgc2NvcGUgPSBncmFtbWFyICYmIGdyYW1tYXIuc2NvcGVOYW1lXG4gIGxldCB1cmlcbiAgaWYgKHNjb3BlICYmIHNjb3BlLmVuZHNXaXRoKCdoYXNrZWxsJykpIHtcbiAgICB1cmkgPSBlZGl0b3IuZ2V0UGF0aCgpXG4gIH0gZWxzZSB7XG4gICAgdXJpID0gJydcbiAgfVxuICByZXR1cm4gYXRvbS53b3Jrc3BhY2Uub3BlbihgaWRlLWhhc2tlbGw6Ly9yZXBsLyR7dXJpfWAsIHtcbiAgICBzcGxpdDogJ3JpZ2h0JyxcbiAgICBzZWFyY2hBbGxQYW5lczogdHJ1ZSxcbiAgICBhY3RpdmF0ZVBhbmU6IGFjdGl2YXRlLFxuICB9KSBhcyBQcm9taXNlPElkZUhhc2tlbGxSZXBsVmlldz5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlYWN0aXZhdGUoKSB7XG4gIHVwaVByb21pc2UgPSB1bmRlZmluZWRcbiAgZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb25zdW1lVVBJKHJlZ2lzdGVyOiBVUEkuSVVQSVJlZ2lzdHJhdGlvbikge1xuICBjb25zdCBjb25zdW1lciA9IG5ldyBVUElDb25zdW1lcihyZWdpc3RlcilcbiAgZGlzcG9zYWJsZXMuYWRkKGNvbnN1bWVyKVxuICByZXNvbHZlVVBJUHJvbWlzZShjb25zdW1lcilcbiAgcmV0dXJuIGNvbnN1bWVyXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhdXRvY29tcGxldGVQcm92aWRlcl8zXzBfMCgpIHtcbiAgcmV0dXJuIHtcbiAgICBzY29wZVNlbGVjdG9yOiAnLnNvdXJjZS5oYXNrZWxsJyxcbiAgICBkaXNhYmxlRm9yU2NvcGVTZWxlY3RvcjogJy5zb3VyY2UuaGFza2VsbCAuY29tbWVudCcsXG4gICAgLy8gZ2V0VGV4dEVkaXRvclNlbGVjdG9yOiAoKSA9PiAnYXRvbS10ZXh0LWVkaXRvci5pZGUtaGFza2VsbC1yZXBsJyxcbiAgICBpbmNsdXNpb25Qcmlvcml0eTogMCxcbiAgICBsYWJlbHM6IFsnaWRlLWhhc2tlbGwtcmVwbCddLFxuICAgIGdldFN1Z2dlc3Rpb25zOiBhc3luYyAoe1xuICAgICAgZWRpdG9yLFxuICAgICAgcHJlZml4LFxuICAgIH06IHtcbiAgICAgIGVkaXRvcjogVGV4dEVkaXRvclxuICAgICAgcHJlZml4OiBzdHJpbmdcbiAgICB9KSA9PiB7XG4gICAgICBjb25zdCB2aWV3ID0gZWRpdG9yTWFwLmdldChlZGl0b3IpXG4gICAgICBpZiAoIXZpZXcpIHtcbiAgICAgICAgcmV0dXJuIFtdXG4gICAgICB9XG4gICAgICByZXR1cm4gdmlldy5nZXRDb21wbGV0aW9ucyhwcmVmaXgpXG4gICAgfSxcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY29uc3VtZVdhdGNoRWRpdG9yKHdhdGNoRWRpdG9yOiBUV2F0Y2hFZGl0b3IpIHtcbiAgcmVzb2x2ZVdhdGNoRWRpdG9yUHJvbWlzZSh3YXRjaEVkaXRvcilcbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5pdFVwaVByb21pc2UoKSB7XG4gIGlmICghdXBpUHJvbWlzZSkge1xuICAgIHVwaVByb21pc2UgPSBuZXcgUHJvbWlzZTxVUElDb25zdW1lciB8IHVuZGVmaW5lZD4oKHJlc29sdmUpID0+IHtcbiAgICAgIHJlc29sdmVVUElQcm9taXNlID0gcmVzb2x2ZVxuICAgIH0pXG4gIH1cbiAgcmV0dXJuIHVwaVByb21pc2Vcbn1cbiJdfQ==