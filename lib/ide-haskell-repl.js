"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const atom_1 = require("atom");
const ide_haskell_repl_view_1 = require("./views/ide-haskell-repl-view");
const upiConsumer_1 = require("./upiConsumer");
const util_1 = require("./util");
const setup_ghci_wrapper_1 = require("./setup-ghci-wrapper");
tslib_1.__exportStar(require("./config"), exports);
let disposables;
const editorMap = new WeakMap();
let resolveUPIPromise;
let upiPromise;
let resolveWatchEditorPromise;
const watchEditorPromise = new Promise((resolve) => {
    resolveWatchEditorPromise = resolve;
});
function activate() {
    disposables = new atom_1.CompositeDisposable();
    switch (atom.config.get('ide-haskell-repl').defaultRepl) {
        case 'cabal':
            atom.config.set('ide-haskell-repl.defaultRepl', 'cabal-v1');
            break;
        case 'cabal-nix':
        case 'cabal-new':
            atom.config.set('ide-haskell-repl.defaultRepl', 'cabal-v2');
            break;
    }
    initUpiPromise();
    disposables.add(atom.workspace.addOpener((uriToOpen) => {
        const m = uriToOpen.match(/^ide-haskell:\/\/repl\/(.*)$/);
        if (m && m[1] !== undefined) {
            return createReplView({ uri: m[1], focus: true });
        }
        return undefined;
    }));
    disposables.add(atom.commands.add('atom-text-editor', 'ide-haskell-repl:toggle', async ({ currentTarget }) => {
        util_1.handlePromise(open(currentTarget.getModel()));
    }));
    if (process.platform === 'win32') {
        disposables.add(atom.commands.add('atom-workspace', 'ide-haskell-repl:setup-ghci-wrapper', setup_ghci_wrapper_1.setupGhciWrapper));
    }
    const commandFunction = (func) => ({ currentTarget, }) => {
        const view = editorMap.get(currentTarget.getModel());
        if (view) {
            ;
            view[func]();
        }
    };
    disposables.add(atom.commands.add('atom-text-editor.ide-haskell-repl', {
        'ide-haskell-repl:exec-command': commandFunction('execCommand'),
        'ide-haskell-repl:history-back': commandFunction('historyBack'),
        'ide-haskell-repl:history-forward': commandFunction('historyForward'),
        'ide-haskell-repl:ghci-reload': commandFunction('ghciReload'),
        'ide-haskell-repl:reload-repeat': commandFunction('ghciReloadRepeat'),
        'ide-haskell-repl:toggle-auto-reload-repeat': commandFunction('toggleAutoReloadRepeat'),
        'ide-haskell-repl:ghci-interrupt': commandFunction('interrupt'),
        'ide-haskell-repl:clear-output': commandFunction('clear'),
    }));
    const externalCommandFunction = (func) => ({ currentTarget, }) => {
        open(currentTarget.getModel(), false).then((model) => model[func]());
    };
    disposables.add(atom.commands.add('atom-text-editor:not(.ide-haskell-repl)', {
        'ide-haskell-repl:copy-selection-to-repl-input': ({ currentTarget }) => {
            const ed = currentTarget.getModel();
            const cmd = ed.getLastSelection().getText();
            open(ed).then((model) => model.copyText(cmd));
        },
        'ide-haskell-repl:run-selection-in-repl': ({ currentTarget }) => {
            const ed = currentTarget.getModel();
            const cmd = ed.getLastSelection().getText();
            open(ed, false).then(async (model) => model.runCommand(cmd));
        },
        'ide-haskell-repl:ghci-reload': externalCommandFunction('ghciReload'),
        'ide-haskell-repl:reload-repeat': externalCommandFunction('ghciReloadRepeat'),
        'ide-haskell-repl:toggle-auto-reload-repeat': externalCommandFunction('toggleAutoReloadRepeat'),
    }));
    disposables.add(atom.menu.add([
        {
            label: 'Haskell IDE',
            submenu: [
                {
                    label: 'Open REPL',
                    command: 'ide-haskell-repl:toggle',
                },
            ],
        },
    ]));
    setTimeout(() => {
        resolveUPIPromise();
    }, 5000);
}
exports.activate = activate;
function createReplView(state) {
    const upiPromise = initUpiPromise();
    const view = new ide_haskell_repl_view_1.IdeHaskellReplView({ upiPromise, state, watchEditorPromise });
    editorMap.set(view.editor, view);
    return view;
}
exports.createReplView = createReplView;
async function open(editor, activate = true) {
    const grammar = editor && editor.getGrammar();
    const scope = grammar && grammar.scopeName;
    let uri;
    if (scope && scope.endsWith('haskell')) {
        uri = editor.getPath();
    }
    else {
        uri = '';
    }
    return atom.workspace.open(`ide-haskell://repl/${uri}`, {
        split: 'right',
        searchAllPanes: true,
        activatePane: activate,
    });
}
function deactivate() {
    upiPromise = undefined;
    disposables.dispose();
}
exports.deactivate = deactivate;
function consumeUPI(register) {
    const consumer = new upiConsumer_1.UPIConsumer(register);
    disposables.add(consumer);
    resolveUPIPromise(consumer);
    return consumer;
}
exports.consumeUPI = consumeUPI;
function autocompleteProvider_3_0_0() {
    return {
        scopeSelector: '.source.haskell',
        disableForScopeSelector: '.source.haskell .comment',
        inclusionPriority: 0,
        labels: ['ide-haskell-repl'],
        getSuggestions: async ({ editor, prefix, }) => {
            const view = editorMap.get(editor);
            if (!view) {
                return [];
            }
            return view.getCompletions(prefix);
        },
    };
}
exports.autocompleteProvider_3_0_0 = autocompleteProvider_3_0_0;
function consumeWatchEditor(watchEditor) {
    resolveWatchEditorPromise(watchEditor);
}
exports.consumeWatchEditor = consumeWatchEditor;
async function initUpiPromise() {
    if (!upiPromise) {
        upiPromise = new Promise((resolve) => {
            resolveUPIPromise = resolve;
        });
    }
    return upiPromise;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRlLWhhc2tlbGwtcmVwbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9pZGUtaGFza2VsbC1yZXBsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLCtCQU1hO0FBQ2IseUVBQThFO0FBRTlFLCtDQUEyQztBQUMzQyxpQ0FBc0M7QUFDdEMsNkRBQXVEO0FBRXZELG1EQUF3QjtBQUV4QixJQUFJLFdBQWdDLENBQUE7QUFDcEMsTUFBTSxTQUFTLEdBQTRDLElBQUksT0FBTyxFQUFFLENBQUE7QUFDeEUsSUFBSSxpQkFBOEMsQ0FBQTtBQUNsRCxJQUFJLFVBQXdELENBQUE7QUFDNUQsSUFBSSx5QkFBcUQsQ0FBQTtBQUN6RCxNQUFNLGtCQUFrQixHQUFHLElBQUksT0FBTyxDQUFlLENBQUMsT0FBTyxFQUFFLEVBQUU7SUFDL0QseUJBQXlCLEdBQUcsT0FBTyxDQUFBO0FBQ3JDLENBQUMsQ0FBQyxDQUFBO0FBRUYsU0FBZ0IsUUFBUTtJQUN0QixXQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO0lBR3ZDLFFBQVEsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxXQUFxQixFQUFFO1FBQ2pFLEtBQUssT0FBTztZQUNWLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLDhCQUE4QixFQUFFLFVBQVUsQ0FBQyxDQUFBO1lBQzNELE1BQUs7UUFDUCxLQUFLLFdBQVcsQ0FBQztRQUNqQixLQUFLLFdBQVc7WUFDZCxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyw4QkFBOEIsRUFBRSxVQUFVLENBQUMsQ0FBQTtZQUMzRCxNQUFLO0tBQ1I7SUFFRCxjQUFjLEVBQUUsQ0FBQTtJQUVoQixXQUFXLENBQUMsR0FBRyxDQUNiLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUMsU0FBaUIsRUFBRSxFQUFFO1FBQzdDLE1BQU0sQ0FBQyxHQUFHLFNBQVMsQ0FBQyxLQUFLLENB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O1FBQ3BCLE1BQU0sRUFBRSxDQUFDLGtCQUFrQixDQUFDO1FBQzVCLGNBQWMsRUFBRSxLQUFLLEVBQUUsRUFDckIsTUFBTSxFQUNOLE1BQU0sR0FJUCxFQUFFLEVBQUU7WUFDSCxNQUFNLElBQUksR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFBO1lBQ2xDLElBQUksQ0FBQyxJQUFJLEVBQUU7Z0JBQ1QsT0FBTyxFQUFFLENBQUE7YUFDVjtZQUNELE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUNwQyxDQUFDO0tBQ0YsQ0FBQTtBQUNILENBQUM7QUFyQkQsZ0VBcUJDO0FBRUQsU0FBZ0Isa0JBQWtCLENBQUMsV0FBeUI7SUFDMUQseUJBQXlCLENBQUMsV0FBVyxDQUFDLENBQUE7QUFDeEMsQ0FBQztBQUZELGdEQUVDO0FBRUQsS0FBSyxVQUFVLGNBQWM7SUFDM0IsSUFBSSxDQUFDLFVBQVUsRUFBRTtRQUNmLFVBQVUsR0FBRyxJQUFJLE9BQU8sQ0FBMEIsQ0FBQyxPQUFPLEVBQUUsRUFBRTtZQUM1RCxpQkFBaUIsR0FBRyxPQUFPLENBQUE7UUFDN0IsQ0FBQyxDQUFDLENBQUE7S0FDSDtJQUNELE9BQU8sVUFBVSxDQUFBO0FBQ25CLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb3NpdGVEaXNwb3NhYmxlLFxuICBUV2F0Y2hFZGl0b3IsXG4gIENvbW1hbmRFdmVudCxcbiAgVGV4dEVkaXRvcixcbiAgVGV4dEVkaXRvckVsZW1lbnQsXG59IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBJZGVIYXNrZWxsUmVwbFZpZXcsIElWaWV3U3RhdGUgfSBmcm9tICcuL3ZpZXdzL2lkZS1oYXNrZWxsLXJlcGwtdmlldydcbmltcG9ydCAqIGFzIFVQSSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xuaW1wb3J0IHsgVVBJQ29uc3VtZXIgfSBmcm9tICcuL3VwaUNvbnN1bWVyJ1xuaW1wb3J0IHsgaGFuZGxlUHJvbWlzZSB9IGZyb20gJy4vdXRpbCdcbmltcG9ydCB7IHNldHVwR2hjaVdyYXBwZXIgfSBmcm9tICcuL3NldHVwLWdoY2ktd3JhcHBlcidcblxuZXhwb3J0ICogZnJvbSAnLi9jb25maWcnXG5cbmxldCBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuY29uc3QgZWRpdG9yTWFwOiBXZWFrTWFwPFRleHRFZGl0b3IsIElkZUhhc2tlbGxSZXBsVmlldz4gPSBuZXcgV2Vha01hcCgpXG5sZXQgcmVzb2x2ZVVQSVByb21pc2U6ICh1cGk/OiBVUElDb25zdW1lcikgPT4gdm9pZFxubGV0IHVwaVByb21pc2U6IFByb21pc2U8VVBJQ29uc3VtZXIgfCB1bmRlZmluZWQ+IHwgdW5kZWZpbmVkXG5sZXQgcmVzb2x2ZVdhdGNoRWRpdG9yUHJvbWlzZTogKHdlOiBUV2F0Y2hFZGl0b3IpID0+IHZvaWRcbmNvbnN0IHdhdGNoRWRpdG9yUHJvbWlzZSA9IG5ldyBQcm9taXNlPFRXYXRjaEVkaXRvcj4oKHJlc29sdmUpID0+IHtcbiAgcmVzb2x2ZVdhdGNoRWRpdG9yUHJvbWlzZSA9IHJlc29sdmVcbn0pXG5cbmV4cG9ydCBmdW5jdGlvbiBhY3RpdmF0ZSgpIHtcbiAgZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG5cbiAgLy8gYmFja3dhcmRzIGNvbXBhdGliaWxpdHlcbiAgc3dpdGNoIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLXJlcGwnKS5kZWZhdWx0UmVwbCBhcyBzdHJpbmcpIHtcbiAgICBjYXNlICdjYWJhbCc6XG4gICAgICBhdG9tLmNvbmZpZy5zZXQoJ2lkZS1oYXNrZWxsLXJlcGwuZGVmYXVsdFJlcGwnLCAnY2FiYWwtdjEnKVxuICAgICAgYnJlYWtcbiAgICBjYXNlICdjYWJhbC1uaXgnOlxuICAgIGNhc2UgJ2NhYmFsLW5ldyc6XG4gICAgICBhdG9tLmNvbmZpZy5zZXQoJ2lkZS1oYXNrZWxsLXJlcGwuZGVmYXVsdFJlcGwnLCAnY2FiYWwtdjInKVxuICAgICAgYnJlYWtcbiAgfVxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgaW5pdFVwaVByb21pc2UoKVxuXG4gIGRpc3Bvc2FibGVzLmFkZChcbiAgICBhdG9tLndvcmtzcGFjZS5hZGRPcGVuZXIoKHVyaVRvT3Blbjogc3RyaW5nKSA9PiB7XG4gICAgICBjb25zdCBtID0gdXJpVG9PcGVuLm1hdGNoKC9eaWRlLWhhc2tlbGw6XFwvXFwvcmVwbFxcLyguKikkLylcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpzdHJpY3QtdHlwZS1wcmVkaWNhdGVzXG4gICAgICBpZiAobSAmJiBtWzFdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIGNyZWF0ZVJlcGxWaWV3KHsgdXJpOiBtWzFdLCBmb2N1czogdHJ1ZSB9KVxuICAgICAgfVxuICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgIH0pLFxuICApXG5cbiAgZGlzcG9zYWJsZXMuYWRkKFxuICAgIGF0b20uY29tbWFuZHMuYWRkKFxuICAgICAgJ2F0b20tdGV4dC1lZGl0b3InLFxuICAgICAgJ2lkZS1oYXNrZWxsLXJlcGw6dG9nZ2xlJyxcbiAgICAgIGFzeW5jICh7IGN1cnJlbnRUYXJnZXQgfSkgPT4ge1xuICAgICAgICBoYW5kbGVQcm9taXNlKG9wZW4oY3VycmVudFRhcmdldC5nZXRNb2RlbCgpKSlcbiAgICAgIH0sXG4gICAgKSxcbiAgKVxuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogdG90YWxpdHktY2hlY2tcbiAgaWYgKHByb2Nlc3MucGxhdGZvcm0gPT09ICd3aW4zMicpIHtcbiAgICBkaXNwb3NhYmxlcy5hZGQoXG4gICAgICBhdG9tLmNvbW1hbmRzLmFkZChcbiAgICAgICAgJ2F0b20td29ya3NwYWNlJyxcbiAgICAgICAgJ2lkZS1oYXNrZWxsLXJlcGw6c2V0dXAtZ2hjaS13cmFwcGVyJyxcbiAgICAgICAgc2V0dXBHaGNpV3JhcHBlcixcbiAgICAgICksXG4gICAgKVxuICB9XG5cbiAgY29uc3QgY29tbWFuZEZ1bmN0aW9uID0gKGZ1bmM6IHN0cmluZykgPT4gKHtcbiAgICBjdXJyZW50VGFyZ2V0LFxuICB9OiBDb21tYW5kRXZlbnQ8VGV4dEVkaXRvckVsZW1lbnQ+KSA9PiB7XG4gICAgY29uc3QgdmlldyA9IGVkaXRvck1hcC5nZXQoY3VycmVudFRhcmdldC5nZXRNb2RlbCgpKVxuICAgIGlmICh2aWV3KSB7XG4gICAgICA7KHZpZXdbZnVuY10gYXMgKCkgPT4gdm9pZCkoKVxuICAgIH1cbiAgfVxuXG4gIGRpc3Bvc2FibGVzLmFkZChcbiAgICBhdG9tLmNvbW1hbmRzLmFkZCgnYXRvbS10ZXh0LWVkaXRvci5pZGUtaGFza2VsbC1yZXBsJywge1xuICAgICAgJ2lkZS1oYXNrZWxsLXJlcGw6ZXhlYy1jb21tYW5kJzogY29tbWFuZEZ1bmN0aW9uKCdleGVjQ29tbWFuZCcpLFxuICAgICAgJ2lkZS1oYXNrZWxsLXJlcGw6aGlzdG9yeS1iYWNrJzogY29tbWFuZEZ1bmN0aW9uKCdoaXN0b3J5QmFjaycpLFxuICAgICAgJ2lkZS1oYXNrZWxsLXJlcGw6aGlzdG9yeS1mb3J3YXJkJzogY29tbWFuZEZ1bmN0aW9uKCdoaXN0b3J5Rm9yd2FyZCcpLFxuICAgICAgJ2lkZS1oYXNrZWxsLXJlcGw6Z2hjaS1yZWxvYWQnOiBjb21tYW5kRnVuY3Rpb24oJ2doY2lSZWxvYWQnKSxcbiAgICAgICdpZGUtaGFza2VsbC1yZXBsOnJlbG9hZC1yZXBlYXQnOiBjb21tYW5kRnVuY3Rpb24oJ2doY2lSZWxvYWRSZXBlYXQnKSxcbiAgICAgICdpZGUtaGFza2VsbC1yZXBsOnRvZ2dsZS1hdXRvLXJlbG9hZC1yZXBlYXQnOiBjb21tYW5kRnVuY3Rpb24oXG4gICAgICAgICd0b2dnbGVBdXRvUmVsb2FkUmVwZWF0JyxcbiAgICAgICksXG4gICAgICAnaWRlLWhhc2tlbGwtcmVwbDpnaGNpLWludGVycnVwdCc6IGNvbW1hbmRGdW5jdGlvbignaW50ZXJydXB0JyksXG4gICAgICAnaWRlLWhhc2tlbGwtcmVwbDpjbGVhci1vdXRwdXQnOiBjb21tYW5kRnVuY3Rpb24oJ2NsZWFyJyksXG4gICAgfSksXG4gIClcblxuICBjb25zdCBleHRlcm5hbENvbW1hbmRGdW5jdGlvbiA9IChmdW5jOiBzdHJpbmcpID0+ICh7XG4gICAgY3VycmVudFRhcmdldCxcbiAgfTogQ29tbWFuZEV2ZW50PFRleHRFZGl0b3JFbGVtZW50PikgPT4ge1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mbG9hdGluZy1wcm9taXNlc1xuICAgIG9wZW4oY3VycmVudFRhcmdldC5nZXRNb2RlbCgpLCBmYWxzZSkudGhlbigobW9kZWwpID0+XG4gICAgICAobW9kZWxbZnVuY10gYXMgKCkgPT4gdm9pZCkoKSxcbiAgICApXG4gIH1cblxuICBkaXNwb3NhYmxlcy5hZGQoXG4gICAgYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20tdGV4dC1lZGl0b3I6bm90KC5pZGUtaGFza2VsbC1yZXBsKScsIHtcbiAgICAgICdpZGUtaGFza2VsbC1yZXBsOmNvcHktc2VsZWN0aW9uLXRvLXJlcGwtaW5wdXQnOiAoeyBjdXJyZW50VGFyZ2V0IH0pID0+IHtcbiAgICAgICAgY29uc3QgZWQgPSBjdXJyZW50VGFyZ2V0LmdldE1vZGVsKClcbiAgICAgICAgY29uc3QgY21kID0gZWQuZ2V0TGFzdFNlbGVjdGlvbigpLmdldFRleHQoKVxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgICAgb3BlbihlZCkudGhlbigobW9kZWwpID0+IG1vZGVsLmNvcHlUZXh0KGNtZCkpXG4gICAgICB9LFxuICAgICAgJ2lkZS1oYXNrZWxsLXJlcGw6cnVuLXNlbGVjdGlvbi1pbi1yZXBsJzogKHsgY3VycmVudFRhcmdldCB9KSA9PiB7XG4gICAgICAgIGNvbnN0IGVkID0gY3VycmVudFRhcmdldC5nZXRNb2RlbCgpXG4gICAgICAgIGNvbnN0IGNtZCA9IGVkLmdldExhc3RTZWxlY3Rpb24oKS5nZXRUZXh0KClcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgICAgIG9wZW4oZWQsIGZhbHNlKS50aGVuKGFzeW5jIChtb2RlbCkgPT4gbW9kZWwucnVuQ29tbWFuZChjbWQpKVxuICAgICAgfSxcbiAgICAgICdpZGUtaGFza2VsbC1yZXBsOmdoY2ktcmVsb2FkJzogZXh0ZXJuYWxDb21tYW5kRnVuY3Rpb24oJ2doY2lSZWxvYWQnKSxcbiAgICAgICdpZGUtaGFza2VsbC1yZXBsOnJlbG9hZC1yZXBlYXQnOiBleHRlcm5hbENvbW1hbmRGdW5jdGlvbihcbiAgICAgICAgJ2doY2lSZWxvYWRSZXBlYXQnLFxuICAgICAgKSxcbiAgICAgICdpZGUtaGFza2VsbC1yZXBsOnRvZ2dsZS1hdXRvLXJlbG9hZC1yZXBlYXQnOiBleHRlcm5hbENvbW1hbmRGdW5jdGlvbihcbiAgICAgICAgJ3RvZ2dsZUF1dG9SZWxvYWRSZXBlYXQnLFxuICAgICAgKSxcbiAgICB9KSxcbiAgKVxuXG4gIGRpc3Bvc2FibGVzLmFkZChcbiAgICBhdG9tLm1lbnUuYWRkKFtcbiAgICAgIHtcbiAgICAgICAgbGFiZWw6ICdIYXNrZWxsIElERScsXG4gICAgICAgIHN1Ym1lbnU6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBsYWJlbDogJ09wZW4gUkVQTCcsXG4gICAgICAgICAgICBjb21tYW5kOiAnaWRlLWhhc2tlbGwtcmVwbDp0b2dnbGUnLFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgIF0pLFxuICApXG5cbiAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgcmVzb2x2ZVVQSVByb21pc2UoKVxuICB9LCA1MDAwKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlUmVwbFZpZXcoc3RhdGU6IElWaWV3U3RhdGUpIHtcbiAgY29uc3QgdXBpUHJvbWlzZSA9IGluaXRVcGlQcm9taXNlKClcbiAgY29uc3QgdmlldyA9IG5ldyBJZGVIYXNrZWxsUmVwbFZpZXcoeyB1cGlQcm9taXNlLCBzdGF0ZSwgd2F0Y2hFZGl0b3JQcm9taXNlIH0pXG4gIGVkaXRvck1hcC5zZXQodmlldy5lZGl0b3IsIHZpZXcpXG4gIHJldHVybiB2aWV3XG59XG5cbmFzeW5jIGZ1bmN0aW9uIG9wZW4oXG4gIGVkaXRvcjogVGV4dEVkaXRvcixcbiAgYWN0aXZhdGUgPSB0cnVlLFxuKTogUHJvbWlzZTxJZGVIYXNrZWxsUmVwbFZpZXc+IHtcbiAgY29uc3QgZ3JhbW1hciA9IGVkaXRvciAmJiBlZGl0b3IuZ2V0R3JhbW1hcigpXG4gIGNvbnN0IHNjb3BlID0gZ3JhbW1hciAmJiBncmFtbWFyLnNjb3BlTmFtZVxuICBsZXQgdXJpXG4gIGlmIChzY29wZSAmJiBzY29wZS5lbmRzV2l0aCgnaGFza2VsbCcpKSB7XG4gICAgdXJpID0gZWRpdG9yLmdldFBhdGgoKVxuICB9IGVsc2Uge1xuICAgIHVyaSA9ICcnXG4gIH1cbiAgcmV0dXJuIGF0b20ud29ya3NwYWNlLm9wZW4oYGlkZS1oYXNrZWxsOi8vcmVwbC8ke3VyaX1gLCB7XG4gICAgc3BsaXQ6ICdyaWdodCcsXG4gICAgc2VhcmNoQWxsUGFuZXM6IHRydWUsXG4gICAgYWN0aXZhdGVQYW5lOiBhY3RpdmF0ZSxcbiAgfSkgYXMgUHJvbWlzZTxJZGVIYXNrZWxsUmVwbFZpZXc+XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWFjdGl2YXRlKCkge1xuICB1cGlQcm9taXNlID0gdW5kZWZpbmVkXG4gIGRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY29uc3VtZVVQSShyZWdpc3RlcjogVVBJLklVUElSZWdpc3RyYXRpb24pIHtcbiAgY29uc3QgY29uc3VtZXIgPSBuZXcgVVBJQ29uc3VtZXIocmVnaXN0ZXIpXG4gIGRpc3Bvc2FibGVzLmFkZChjb25zdW1lcilcbiAgcmVzb2x2ZVVQSVByb21pc2UoY29uc3VtZXIpXG4gIHJldHVybiBjb25zdW1lclxufVxuXG5leHBvcnQgZnVuY3Rpb24gYXV0b2NvbXBsZXRlUHJvdmlkZXJfM18wXzAoKSB7XG4gIHJldHVybiB7XG4gICAgc2NvcGVTZWxlY3RvcjogJy5zb3VyY2UuaGFza2VsbCcsXG4gICAgZGlzYWJsZUZvclNjb3BlU2VsZWN0b3I6ICcuc291cmNlLmhhc2tlbGwgLmNvbW1lbnQnLFxuICAgIC8vIGdldFRleHRFZGl0b3JTZWxlY3RvcjogKCkgPT4gJ2F0b20tdGV4dC1lZGl0b3IuaWRlLWhhc2tlbGwtcmVwbCcsXG4gICAgaW5jbHVzaW9uUHJpb3JpdHk6IDAsXG4gICAgbGFiZWxzOiBbJ2lkZS1oYXNrZWxsLXJlcGwnXSxcbiAgICBnZXRTdWdnZXN0aW9uczogYXN5bmMgKHtcbiAgICAgIGVkaXRvcixcbiAgICAgIHByZWZpeCxcbiAgICB9OiB7XG4gICAgICBlZGl0b3I6IFRleHRFZGl0b3JcbiAgICAgIHByZWZpeDogc3RyaW5nXG4gICAgfSkgPT4ge1xuICAgICAgY29uc3QgdmlldyA9IGVkaXRvck1hcC5nZXQoZWRpdG9yKVxuICAgICAgaWYgKCF2aWV3KSB7XG4gICAgICAgIHJldHVybiBbXVxuICAgICAgfVxuICAgICAgcmV0dXJuIHZpZXcuZ2V0Q29tcGxldGlvbnMocHJlZml4KVxuICAgIH0sXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbnN1bWVXYXRjaEVkaXRvcih3YXRjaEVkaXRvcjogVFdhdGNoRWRpdG9yKSB7XG4gIHJlc29sdmVXYXRjaEVkaXRvclByb21pc2Uod2F0Y2hFZGl0b3IpXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluaXRVcGlQcm9taXNlKCkge1xuICBpZiAoIXVwaVByb21pc2UpIHtcbiAgICB1cGlQcm9taXNlID0gbmV3IFByb21pc2U8VVBJQ29uc3VtZXIgfCB1bmRlZmluZWQ+KChyZXNvbHZlKSA9PiB7XG4gICAgICByZXNvbHZlVVBJUHJvbWlzZSA9IHJlc29sdmVcbiAgICB9KVxuICB9XG4gIHJldHVybiB1cGlQcm9taXNlXG59XG4iXX0=