"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const atom_1 = require("atom");
const ide_haskell_repl_view_1 = require("./views/ide-haskell-repl-view");
const upiConsumer_1 = require("./upiConsumer");
const util_1 = require("./util");
tslib_1.__exportStar(require("./config"), exports);
let disposables;
const editorMap = new WeakMap();
let resolveUPIPromise;
let upiPromise;
let resolveWatchEditorPromise;
const watchEditorPromise = new Promise((resolve) => {
    resolveWatchEditorPromise = resolve;
});
function activate() {
    disposables = new atom_1.CompositeDisposable();
    initUpiPromise();
    disposables.add(atom.workspace.addOpener((uriToOpen) => {
        const m = uriToOpen.match(/^ide-haskell:\/\/repl\/(.*)$/);
        if (m && m[1] !== undefined) {
            return createReplView({ uri: m[1], focus: true });
        }
        return undefined;
    }));
    disposables.add(atom.commands.add('atom-text-editor', 'ide-haskell-repl:toggle', async ({ currentTarget }) => {
        util_1.handlePromise(open(currentTarget.getModel()));
    }));
    const commandFunction = (func) => ({ currentTarget, }) => {
        const view = editorMap.get(currentTarget.getModel());
        if (view) {
            ;
            view[func]();
        }
    };
    disposables.add(atom.commands.add('atom-text-editor.ide-haskell-repl', {
        'ide-haskell-repl:exec-command': commandFunction('execCommand'),
        'ide-haskell-repl:history-back': commandFunction('historyBack'),
        'ide-haskell-repl:history-forward': commandFunction('historyForward'),
        'ide-haskell-repl:ghci-reload': commandFunction('ghciReload'),
        'ide-haskell-repl:reload-repeat': commandFunction('ghciReloadRepeat'),
        'ide-haskell-repl:toggle-auto-reload-repeat': commandFunction('toggleAutoReloadRepeat'),
        'ide-haskell-repl:ghci-interrupt': commandFunction('interrupt'),
        'ide-haskell-repl:clear-output': commandFunction('clear'),
    }));
    const externalCommandFunction = (func) => ({ currentTarget, }) => {
        open(currentTarget.getModel(), false).then((model) => model[func]());
    };
    disposables.add(atom.commands.add('atom-text-editor:not(.ide-haskell-repl)', {
        'ide-haskell-repl:copy-selection-to-repl-input': ({ currentTarget }) => {
            const ed = currentTarget.getModel();
            const cmd = ed.getLastSelection().getText();
            open(ed).then((model) => model.copyText(cmd));
        },
        'ide-haskell-repl:run-selection-in-repl': ({ currentTarget }) => {
            const ed = currentTarget.getModel();
            const cmd = ed.getLastSelection().getText();
            open(ed, false).then(async (model) => model.runCommand(cmd));
        },
        'ide-haskell-repl:ghci-reload': externalCommandFunction('ghciReload'),
        'ide-haskell-repl:reload-repeat': externalCommandFunction('ghciReloadRepeat'),
        'ide-haskell-repl:toggle-auto-reload-repeat': externalCommandFunction('toggleAutoReloadRepeat'),
    }));
    disposables.add(atom.menu.add([
        {
            label: 'Haskell IDE',
            submenu: [
                {
                    label: 'Open REPL',
                    command: 'ide-haskell-repl:toggle',
                },
            ],
        },
    ]));
    setTimeout(() => {
        resolveUPIPromise();
    }, 5000);
}
exports.activate = activate;
function createReplView(state) {
    const upiPromise = initUpiPromise();
    const view = new ide_haskell_repl_view_1.IdeHaskellReplView({ upiPromise, state, watchEditorPromise });
    editorMap.set(view.editor, view);
    return view;
}
exports.createReplView = createReplView;
async function open(editor, activate = true) {
    const grammar = editor && editor.getGrammar();
    const scope = grammar && grammar.scopeName;
    let uri;
    if (scope && scope.endsWith('haskell')) {
        uri = editor.getPath();
    }
    else {
        uri = '';
    }
    return atom.workspace.open(`ide-haskell://repl/${uri}`, {
        split: 'right',
        searchAllPanes: true,
        activatePane: activate,
    });
}
function deactivate() {
    upiPromise = undefined;
    disposables.dispose();
}
exports.deactivate = deactivate;
function consumeUPI(register) {
    const consumer = new upiConsumer_1.UPIConsumer(register);
    disposables.add(consumer);
    resolveUPIPromise(consumer);
    return consumer;
}
exports.consumeUPI = consumeUPI;
function autocompleteProvider_3_0_0() {
    return {
        scopeSelector: '.source.haskell',
        disableForScopeSelector: '.source.haskell .comment',
        inclusionPriority: 0,
        labels: ['ide-haskell-repl'],
        getSuggestions: async ({ editor, prefix, }) => {
            const view = editorMap.get(editor);
            if (!view) {
                return [];
            }
            return view.getCompletions(prefix);
        },
    };
}
exports.autocompleteProvider_3_0_0 = autocompleteProvider_3_0_0;
function consumeWatchEditor(watchEditor) {
    resolveWatchEditorPromise(watchEditor);
}
exports.consumeWatchEditor = consumeWatchEditor;
async function initUpiPromise() {
    if (!upiPromise) {
        upiPromise = new Promise((resolve) => {
            resolveUPIPromise = resolve;
        });
    }
    return upiPromise;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRlLWhhc2tlbGwtcmVwbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9pZGUtaGFza2VsbC1yZXBsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLCtCQU1hO0FBQ2IseUVBQThFO0FBRTlFLCtDQUEyQztBQUMzQyxpQ0FBc0M7QUFFdEMsbURBQXdCO0FBRXhCLElBQUksV0FBZ0MsQ0FBQTtBQUNwQyxNQUFNLFNBQVMsR0FBNEMsSUFBSSxPQUFPLEVBQUUsQ0FBQTtBQUN4RSxJQUFJLGlCQUE4QyxDQUFBO0FBQ2xELElBQUksVUFBd0QsQ0FBQTtBQUM1RCxJQUFJLHlCQUFxRCxDQUFBO0FBQ3pELE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxPQUFPLENBQWUsQ0FBQyxPQUFPLEVBQUUsRUFBRTtJQUMvRCx5QkFBeUIsR0FBRyxPQUFPLENBQUE7QUFDckMsQ0FBQyxDQUFDLENBQUE7QUFFRixTQUFnQixRQUFRO0lBQ3RCLFdBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7SUFFdkMsY0FBYyxFQUFFLENBQUE7SUFFaEIsV0FBVyxDQUFDLEdBQUcsQ0FDYixJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFNBQWlCLEVBQUUsRUFBRTtRQUM3QyxNQUFNLENBQUMsR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLDhCQUE4QixDQUFDLENBQUE7UUFFekQsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLFNBQVMsRUFBRTtZQUMzQixPQUFPLGNBQWMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUE7U0FDbEQ7UUFDRCxPQUFPLFNBQVMsQ0FBQTtJQUNsQixDQUFDLENBQUMsQ0FDSCxDQUFBO0lBRUQsV0FBVyxDQUFDLEdBQUcsQ0FDYixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FDZixrQkFBa0IsRUFD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QUcsSUFBSSxPQUFPLENBQTBCLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDNUQsaUJBQWlCLEdBQUcsT0FBTyxDQUFBO1FBQzdCLENBQUMsQ0FBQyxDQUFBO0tBQ0g7SUFDRCxPQUFPLFVBQVUsQ0FBQTtBQUNuQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9zaXRlRGlzcG9zYWJsZSxcbiAgVFdhdGNoRWRpdG9yLFxuICBDb21tYW5kRXZlbnQsXG4gIFRleHRFZGl0b3IsXG4gIFRleHRFZGl0b3JFbGVtZW50LFxufSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgSWRlSGFza2VsbFJlcGxWaWV3LCBJVmlld1N0YXRlIH0gZnJvbSAnLi92aWV3cy9pZGUtaGFza2VsbC1yZXBsLXZpZXcnXG5pbXBvcnQgKiBhcyBVUEkgZnJvbSAnYXRvbS1oYXNrZWxsLXVwaSdcbmltcG9ydCB7IFVQSUNvbnN1bWVyIH0gZnJvbSAnLi91cGlDb25zdW1lcidcbmltcG9ydCB7IGhhbmRsZVByb21pc2UgfSBmcm9tICcuL3V0aWwnXG5cbmV4cG9ydCAqIGZyb20gJy4vY29uZmlnJ1xuXG5sZXQgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGVcbmNvbnN0IGVkaXRvck1hcDogV2Vha01hcDxUZXh0RWRpdG9yLCBJZGVIYXNrZWxsUmVwbFZpZXc+ID0gbmV3IFdlYWtNYXAoKVxubGV0IHJlc29sdmVVUElQcm9taXNlOiAodXBpPzogVVBJQ29uc3VtZXIpID0+IHZvaWRcbmxldCB1cGlQcm9taXNlOiBQcm9taXNlPFVQSUNvbnN1bWVyIHwgdW5kZWZpbmVkPiB8IHVuZGVmaW5lZFxubGV0IHJlc29sdmVXYXRjaEVkaXRvclByb21pc2U6ICh3ZTogVFdhdGNoRWRpdG9yKSA9PiB2b2lkXG5jb25zdCB3YXRjaEVkaXRvclByb21pc2UgPSBuZXcgUHJvbWlzZTxUV2F0Y2hFZGl0b3I+KChyZXNvbHZlKSA9PiB7XG4gIHJlc29sdmVXYXRjaEVkaXRvclByb21pc2UgPSByZXNvbHZlXG59KVxuXG5leHBvcnQgZnVuY3Rpb24gYWN0aXZhdGUoKSB7XG4gIGRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgaW5pdFVwaVByb21pc2UoKVxuXG4gIGRpc3Bvc2FibGVzLmFkZChcbiAgICBhdG9tLndvcmtzcGFjZS5hZGRPcGVuZXIoKHVyaVRvT3Blbjogc3RyaW5nKSA9PiB7XG4gICAgICBjb25zdCBtID0gdXJpVG9PcGVuLm1hdGNoKC9eaWRlLWhhc2tlbGw6XFwvXFwvcmVwbFxcLyguKikkLylcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpzdHJpY3QtdHlwZS1wcmVkaWNhdGVzXG4gICAgICBpZiAobSAmJiBtWzFdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIGNyZWF0ZVJlcGxWaWV3KHsgdXJpOiBtWzFdLCBmb2N1czogdHJ1ZSB9KVxuICAgICAgfVxuICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgIH0pLFxuICApXG5cbiAgZGlzcG9zYWJsZXMuYWRkKFxuICAgIGF0b20uY29tbWFuZHMuYWRkKFxuICAgICAgJ2F0b20tdGV4dC1lZGl0b3InLFxuICAgICAgJ2lkZS1oYXNrZWxsLXJlcGw6dG9nZ2xlJyxcbiAgICAgIGFzeW5jICh7IGN1cnJlbnRUYXJnZXQgfSkgPT4ge1xuICAgICAgICBoYW5kbGVQcm9taXNlKG9wZW4oY3VycmVudFRhcmdldC5nZXRNb2RlbCgpKSlcbiAgICAgIH0sXG4gICAgKSxcbiAgKVxuXG4gIGNvbnN0IGNvbW1hbmRGdW5jdGlvbiA9IChmdW5jOiBzdHJpbmcpID0+ICh7XG4gICAgY3VycmVudFRhcmdldCxcbiAgfTogQ29tbWFuZEV2ZW50PFRleHRFZGl0b3JFbGVtZW50PikgPT4ge1xuICAgIGNvbnN0IHZpZXcgPSBlZGl0b3JNYXAuZ2V0KGN1cnJlbnRUYXJnZXQuZ2V0TW9kZWwoKSlcbiAgICBpZiAodmlldykge1xuICAgICAgOyh2aWV3W2Z1bmNdIGFzICgpID0+IHZvaWQpKClcbiAgICB9XG4gIH1cblxuICBkaXNwb3NhYmxlcy5hZGQoXG4gICAgYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20tdGV4dC1lZGl0b3IuaWRlLWhhc2tlbGwtcmVwbCcsIHtcbiAgICAgICdpZGUtaGFza2VsbC1yZXBsOmV4ZWMtY29tbWFuZCc6IGNvbW1hbmRGdW5jdGlvbignZXhlY0NvbW1hbmQnKSxcbiAgICAgICdpZGUtaGFza2VsbC1yZXBsOmhpc3RvcnktYmFjayc6IGNvbW1hbmRGdW5jdGlvbignaGlzdG9yeUJhY2snKSxcbiAgICAgICdpZGUtaGFza2VsbC1yZXBsOmhpc3RvcnktZm9yd2FyZCc6IGNvbW1hbmRGdW5jdGlvbignaGlzdG9yeUZvcndhcmQnKSxcbiAgICAgICdpZGUtaGFza2VsbC1yZXBsOmdoY2ktcmVsb2FkJzogY29tbWFuZEZ1bmN0aW9uKCdnaGNpUmVsb2FkJyksXG4gICAgICAnaWRlLWhhc2tlbGwtcmVwbDpyZWxvYWQtcmVwZWF0JzogY29tbWFuZEZ1bmN0aW9uKCdnaGNpUmVsb2FkUmVwZWF0JyksXG4gICAgICAnaWRlLWhhc2tlbGwtcmVwbDp0b2dnbGUtYXV0by1yZWxvYWQtcmVwZWF0JzogY29tbWFuZEZ1bmN0aW9uKFxuICAgICAgICAndG9nZ2xlQXV0b1JlbG9hZFJlcGVhdCcsXG4gICAgICApLFxuICAgICAgJ2lkZS1oYXNrZWxsLXJlcGw6Z2hjaS1pbnRlcnJ1cHQnOiBjb21tYW5kRnVuY3Rpb24oJ2ludGVycnVwdCcpLFxuICAgICAgJ2lkZS1oYXNrZWxsLXJlcGw6Y2xlYXItb3V0cHV0JzogY29tbWFuZEZ1bmN0aW9uKCdjbGVhcicpLFxuICAgIH0pLFxuICApXG5cbiAgY29uc3QgZXh0ZXJuYWxDb21tYW5kRnVuY3Rpb24gPSAoZnVuYzogc3RyaW5nKSA9PiAoe1xuICAgIGN1cnJlbnRUYXJnZXQsXG4gIH06IENvbW1hbmRFdmVudDxUZXh0RWRpdG9yRWxlbWVudD4pID0+IHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICBvcGVuKGN1cnJlbnRUYXJnZXQuZ2V0TW9kZWwoKSwgZmFsc2UpLnRoZW4oKG1vZGVsKSA9PlxuICAgICAgKG1vZGVsW2Z1bmNdIGFzICgpID0+IHZvaWQpKCksXG4gICAgKVxuICB9XG5cbiAgZGlzcG9zYWJsZXMuYWRkKFxuICAgIGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXRleHQtZWRpdG9yOm5vdCguaWRlLWhhc2tlbGwtcmVwbCknLCB7XG4gICAgICAnaWRlLWhhc2tlbGwtcmVwbDpjb3B5LXNlbGVjdGlvbi10by1yZXBsLWlucHV0JzogKHsgY3VycmVudFRhcmdldCB9KSA9PiB7XG4gICAgICAgIGNvbnN0IGVkID0gY3VycmVudFRhcmdldC5nZXRNb2RlbCgpXG4gICAgICAgIGNvbnN0IGNtZCA9IGVkLmdldExhc3RTZWxlY3Rpb24oKS5nZXRUZXh0KClcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgICAgIG9wZW4oZWQpLnRoZW4oKG1vZGVsKSA9PiBtb2RlbC5jb3B5VGV4dChjbWQpKVxuICAgICAgfSxcbiAgICAgICdpZGUtaGFza2VsbC1yZXBsOnJ1bi1zZWxlY3Rpb24taW4tcmVwbCc6ICh7IGN1cnJlbnRUYXJnZXQgfSkgPT4ge1xuICAgICAgICBjb25zdCBlZCA9IGN1cnJlbnRUYXJnZXQuZ2V0TW9kZWwoKVxuICAgICAgICBjb25zdCBjbWQgPSBlZC5nZXRMYXN0U2VsZWN0aW9uKCkuZ2V0VGV4dCgpXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mbG9hdGluZy1wcm9taXNlc1xuICAgICAgICBvcGVuKGVkLCBmYWxzZSkudGhlbihhc3luYyAobW9kZWwpID0+IG1vZGVsLnJ1bkNvbW1hbmQoY21kKSlcbiAgICAgIH0sXG4gICAgICAnaWRlLWhhc2tlbGwtcmVwbDpnaGNpLXJlbG9hZCc6IGV4dGVybmFsQ29tbWFuZEZ1bmN0aW9uKCdnaGNpUmVsb2FkJyksXG4gICAgICAnaWRlLWhhc2tlbGwtcmVwbDpyZWxvYWQtcmVwZWF0JzogZXh0ZXJuYWxDb21tYW5kRnVuY3Rpb24oXG4gICAgICAgICdnaGNpUmVsb2FkUmVwZWF0JyxcbiAgICAgICksXG4gICAgICAnaWRlLWhhc2tlbGwtcmVwbDp0b2dnbGUtYXV0by1yZWxvYWQtcmVwZWF0JzogZXh0ZXJuYWxDb21tYW5kRnVuY3Rpb24oXG4gICAgICAgICd0b2dnbGVBdXRvUmVsb2FkUmVwZWF0JyxcbiAgICAgICksXG4gICAgfSksXG4gIClcblxuICBkaXNwb3NhYmxlcy5hZGQoXG4gICAgYXRvbS5tZW51LmFkZChbXG4gICAgICB7XG4gICAgICAgIGxhYmVsOiAnSGFza2VsbCBJREUnLFxuICAgICAgICBzdWJtZW51OiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgbGFiZWw6ICdPcGVuIFJFUEwnLFxuICAgICAgICAgICAgY29tbWFuZDogJ2lkZS1oYXNrZWxsLXJlcGw6dG9nZ2xlJyxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgfSxcbiAgICBdKSxcbiAgKVxuXG4gIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgIHJlc29sdmVVUElQcm9taXNlKClcbiAgfSwgNTAwMClcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVJlcGxWaWV3KHN0YXRlOiBJVmlld1N0YXRlKSB7XG4gIGNvbnN0IHVwaVByb21pc2UgPSBpbml0VXBpUHJvbWlzZSgpXG4gIGNvbnN0IHZpZXcgPSBuZXcgSWRlSGFza2VsbFJlcGxWaWV3KHsgdXBpUHJvbWlzZSwgc3RhdGUsIHdhdGNoRWRpdG9yUHJvbWlzZSB9KVxuICBlZGl0b3JNYXAuc2V0KHZpZXcuZWRpdG9yLCB2aWV3KVxuICByZXR1cm4gdmlld1xufVxuXG5hc3luYyBmdW5jdGlvbiBvcGVuKFxuICBlZGl0b3I6IFRleHRFZGl0b3IsXG4gIGFjdGl2YXRlID0gdHJ1ZSxcbik6IFByb21pc2U8SWRlSGFza2VsbFJlcGxWaWV3PiB7XG4gIGNvbnN0IGdyYW1tYXIgPSBlZGl0b3IgJiYgZWRpdG9yLmdldEdyYW1tYXIoKVxuICBjb25zdCBzY29wZSA9IGdyYW1tYXIgJiYgZ3JhbW1hci5zY29wZU5hbWVcbiAgbGV0IHVyaVxuICBpZiAoc2NvcGUgJiYgc2NvcGUuZW5kc1dpdGgoJ2hhc2tlbGwnKSkge1xuICAgIHVyaSA9IGVkaXRvci5nZXRQYXRoKClcbiAgfSBlbHNlIHtcbiAgICB1cmkgPSAnJ1xuICB9XG4gIHJldHVybiBhdG9tLndvcmtzcGFjZS5vcGVuKGBpZGUtaGFza2VsbDovL3JlcGwvJHt1cml9YCwge1xuICAgIHNwbGl0OiAncmlnaHQnLFxuICAgIHNlYXJjaEFsbFBhbmVzOiB0cnVlLFxuICAgIGFjdGl2YXRlUGFuZTogYWN0aXZhdGUsXG4gIH0pIGFzIFByb21pc2U8SWRlSGFza2VsbFJlcGxWaWV3PlxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVhY3RpdmF0ZSgpIHtcbiAgdXBpUHJvbWlzZSA9IHVuZGVmaW5lZFxuICBkaXNwb3NhYmxlcy5kaXNwb3NlKClcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbnN1bWVVUEkocmVnaXN0ZXI6IFVQSS5JVVBJUmVnaXN0cmF0aW9uKSB7XG4gIGNvbnN0IGNvbnN1bWVyID0gbmV3IFVQSUNvbnN1bWVyKHJlZ2lzdGVyKVxuICBkaXNwb3NhYmxlcy5hZGQoY29uc3VtZXIpXG4gIHJlc29sdmVVUElQcm9taXNlKGNvbnN1bWVyKVxuICByZXR1cm4gY29uc3VtZXJcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGF1dG9jb21wbGV0ZVByb3ZpZGVyXzNfMF8wKCkge1xuICByZXR1cm4ge1xuICAgIHNjb3BlU2VsZWN0b3I6ICcuc291cmNlLmhhc2tlbGwnLFxuICAgIGRpc2FibGVGb3JTY29wZVNlbGVjdG9yOiAnLnNvdXJjZS5oYXNrZWxsIC5jb21tZW50JyxcbiAgICAvLyBnZXRUZXh0RWRpdG9yU2VsZWN0b3I6ICgpID0+ICdhdG9tLXRleHQtZWRpdG9yLmlkZS1oYXNrZWxsLXJlcGwnLFxuICAgIGluY2x1c2lvblByaW9yaXR5OiAwLFxuICAgIGxhYmVsczogWydpZGUtaGFza2VsbC1yZXBsJ10sXG4gICAgZ2V0U3VnZ2VzdGlvbnM6IGFzeW5jICh7XG4gICAgICBlZGl0b3IsXG4gICAgICBwcmVmaXgsXG4gICAgfToge1xuICAgICAgZWRpdG9yOiBUZXh0RWRpdG9yXG4gICAgICBwcmVmaXg6IHN0cmluZ1xuICAgIH0pID0+IHtcbiAgICAgIGNvbnN0IHZpZXcgPSBlZGl0b3JNYXAuZ2V0KGVkaXRvcilcbiAgICAgIGlmICghdmlldykge1xuICAgICAgICByZXR1cm4gW11cbiAgICAgIH1cbiAgICAgIHJldHVybiB2aWV3LmdldENvbXBsZXRpb25zKHByZWZpeClcbiAgICB9LFxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb25zdW1lV2F0Y2hFZGl0b3Iod2F0Y2hFZGl0b3I6IFRXYXRjaEVkaXRvcikge1xuICByZXNvbHZlV2F0Y2hFZGl0b3JQcm9taXNlKHdhdGNoRWRpdG9yKVxufVxuXG5hc3luYyBmdW5jdGlvbiBpbml0VXBpUHJvbWlzZSgpIHtcbiAgaWYgKCF1cGlQcm9taXNlKSB7XG4gICAgdXBpUHJvbWlzZSA9IG5ldyBQcm9taXNlPFVQSUNvbnN1bWVyIHwgdW5kZWZpbmVkPigocmVzb2x2ZSkgPT4ge1xuICAgICAgcmVzb2x2ZVVQSVByb21pc2UgPSByZXNvbHZlXG4gICAgfSlcbiAgfVxuICByZXR1cm4gdXBpUHJvbWlzZVxufVxuIl19